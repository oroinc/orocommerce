workflows:
    b2b_flow_alternative_checkout:
        entity: Oro\Bundle\CheckoutBundle\Entity\Checkout
        entity_attribute: checkout
        steps_display_ordered: true

        defaults:
            active: false
        exclusive_record_groups:
            - b2b_checkout_flow
        priority: 100

        scopes:
            -
                customer: 4

        applications: ['commerce']

        variable_definitions:
            variables:
                order_approval_threshold:
                    type: 'float'
                    value: 5000
                    options:
                        form_options:
                            constraints:
                                NotBlank: ~
                            tooltip: true

        attributes:
            allowed:
                type: bool
            allow_request_date:
                type: object
                options:
                    class: DateTime
            requested_for_approve:
                type: bool
            request_approval_notes:
                type: string
            billing_address:
                property_path: checkout.billingAddress
            shipping_address:
                property_path: checkout.shippingAddress
            save_billing_address:
                property_path: checkout.saveBillingAddress
            save_shipping_address:
                property_path: checkout.saveShippingAddress
            ship_to_billing_address:
                property_path: checkout.shipToBillingAddress
            po_number:
                property_path: checkout.poNumber
            ship_until:
                property_path: checkout.shipUntil
            customer_notes:
                property_path: checkout.customerNotes
            payment_method:
                property_path: checkout.paymentMethod
            shipping_method:
                property_path: checkout.shippingMethod
            shipping_method_type:
                property_path: checkout.shippingMethodType
            billing_address_has_shipping:
                type: boolean
            allow_manual_source_remove:
                type: boolean
            disallow_billing_address_edit:
                type: boolean
            disallow_shipping_address_edit:
                type: boolean
            disallow_shipping_method_edit:
                type: boolean
            remove_source:
                type: boolean
            clear_source:
                type: boolean
            auto_remove_source:
                type: boolean
            source_remove_label:
                type: string
            edit_order_link:
                type: string
            payment_in_progress:
                type: bool
            payment_validate:
                type: bool
            payment_save_for_later:
                type: bool
            additional_data:
                type: string
            state_token:
                type: string
            order:
                type: entity
                options:
                    class: Oro\Bundle\OrderBundle\Entity\Order
            email:
                type: string
            customerConsents:
                type: array
            consents_available:
                type: boolean
        steps:
            customer_consents:
                order: 10
                allowed_transitions:
                    - continue_to_billing_address
            enter_billing_address:
                order: 20
                allowed_transitions:
                    - verify_customer_consents
                    - back_to_customer_consents
                    - continue_to_shipping_address
            enter_shipping_address:
                order: 30
                allowed_transitions:
                    - verify_customer_consents
                    - continue_to_shipping_method
                    - back_to_customer_consents
                    - back_to_billing_address
            enter_shipping_method:
                order: 40
                allowed_transitions:
                    - verify_customer_consents
                    - continue_to_payment
                    - back_to_customer_consents
                    - back_to_billing_address
                    - back_to_shipping_address
            enter_payment:
                order: 50
                allowed_transitions:
                    - verify_customer_consents
                    - payment_error
                    - continue_to_order_review
                    - back_to_customer_consents
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
            order_review:
                order: 60
                allowed_transitions:
                    - verify_customer_consents
                    - continue_to_request_approval
                    - place_order
                    - verify_payment
                    - finish_checkout
                    - payment_error
                    - back_to_customer_consents
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
                    - back_to_shipping_address_on_fail_address
            request_approval:
                order: 70
                allowed_transitions:
                    - verify_customer_consents
                    - continue_to_approve_request
                    - back_to_customer_consents
                    - back_to_billing_address
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
                    - back_to_order_review
            approve_request:
                order: 80
                allowed_transitions:
                    - verify_customer_consents
                    - approve_order
                    - verify_payment
                    - finish_checkout
                    - payment_error
                    - place_order_with_inactive_possibility
                    - back_to_customer_consents
                    - back_to_billing_address
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
                    - back_to_order_review
                    - back_to_request_approval
            order_created:
                order: 90
                is_final: true

        transitions:
            __start__:
                is_start: true
                is_hidden: true
                step_to: enter_billing_address
                transition_definition: __start___definition
            start_from_shoppinglist:
                is_start: true
                step_to: enter_billing_address
                is_unavailable_hidden: true
                transition_definition: start_from_shoppinglist_definition
                frontend_options:
                    icon: fa-briefcase
                    data:
                      component_name: oro_shopping_list_matrix_to_create_order
                      page-component-module: oroshoppinglist/js/app/components/shoppinglist-create-order-button-component
                      page-component-options:
                          component_name: '[name$="[component]"]'
                          hasEmptyMatrix: $.result.shoppingListHasEmptyMatrix
                init_routes:
                    - oro_shopping_list_frontend_view
                    - oro_shopping_list_frontend_view_grid
                    - oro_shopping_list_frontend_update
                init_entities:
                    - 'Oro\Bundle\ShoppingListBundle\Entity\ShoppingList'
                acl_resource: [CHECKOUT_CREATE, $.result.shoppingList]

            start_from_quickorderform:
                is_start: true
                step_to: enter_billing_address
                is_unavailable_hidden: true
                transition_definition: start_from_quickorderform_definition
                frontend_options:
                    icon: fa-briefcase
                    class: 'btn--action'
                    data:
                        component_name: oro_shopping_list_to_checkout_quick_add_processor
                        page-component-module: oroproduct/js/app/components/quick-add-form-button-component
                        page-component-options:
                            component_name: '[name$="[component]"]'
                            confirmation: $.result.doShowConfirmation
                            shopping_list_limit: $.result.shoppingListLimit
                init_routes:
                    - oro_product_frontend_quick_add
                    - oro_product_frontend_quick_add_copy_paste
                    - oro_product_frontend_quick_add_import
                acl_resource: [CREATE, entity:commerce@Oro\Bundle\CheckoutBundle\Entity\Checkout]

            continue_to_billing_address:
                step_to: enter_billing_address
                transition_definition: continue_to_billing_address_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@assign_value': [$customerConsents, null]
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        customerConsents:
                            form_type: Oro\Bundle\ConsentBundle\Form\Type\ConsentAcceptanceType
                            options:
                                required: true
                                property_path: customerConsents
                                constraints:
                                    - Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedConsents: ~
                                    - Oro\Bundle\ConsentBundle\Validator\Constraints\RemovedLandingPages: ~
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            continue_to_shipping_address:
                step_to: enter_shipping_address
                transition_definition: continue_to_shipping_address_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressType
                            options:
                                object: $checkout
                                addressType: 'billing'
                                required: true
                                translation_domain: messages
                                constraints:
                                    - Valid: ~
                                    - NotBlank: ~
                                    - Oro\Bundle\AddressBundle\Validator\Constraints\NameOrOrganization: ~
                                disabled: $disallow_billing_address_edit
                        save_billing_address:
                            options:
                        ship_to_billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\ShipToBillingAddressType
                            options:
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                        email:
                            form_type: Oro\Bundle\CustomerBundle\Form\Type\CustomerVisitorEmailAddressType
            continue_to_shipping_method:
                step_to: enter_shipping_method
                transition_definition: continue_to_shipping_method_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        shipping_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutAddressType
                            options:
                                object: $checkout
                                addressType: 'shipping'
                                required: true
                                disabled: $disallow_shipping_address_edit
                                translation_domain: messages
                                constraints:
                                    - Valid: ~
                                    - NotBlank: ~
                                    - Oro\Bundle\AddressBundle\Validator\Constraints\NameOrOrganization: ~
                        save_shipping_address:
                            options:
                        ship_to_billing_address:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\ShipToBillingAddressType
                            options:
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            continue_to_payment:
                step_to: enter_payment
                transition_definition: continue_to_payment_definition
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                    page_component_module: 'orocheckout/js/app/components/shipping-transition-button-component'
                form_options:
                    form_init:
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        shipping_method:
                            options:
                                constraints:
                                    - NotBlank: ~
                        shipping_method_type:
                            options:
                                constraints:
                                    - NotBlank: ~
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            continue_to_order_review:
                step_to: order_review
                transition_definition: continue_to_order_review_definition
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                    page_component_module: 'orocheckout/js/app/components/payment-transition-button-component'
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@tree':
                            conditions:
                                '@blank': $payment_validate
                            actions:
                                - '@assign_value': [$payment_validate, true]
                                - '@call_service_method':
                                    conditions:
                                        '@blank': $.result.validatePaymentTransaction
                                    parameters:
                                        service: oro_payment.provider.payment_transaction
                                        method: getActiveValidatePaymentTransaction
                                        method_parameters: [$payment_method]
                                        attribute: $.result.validatePaymentTransaction
                                - '@assign_value':
                                    conditions:
                                        '@not_empty': [$.result.validatePaymentTransaction]
                                    parameters: [$payment_validate, false]
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        payment_method: ~
                        payment_validate:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                        payment_save_for_later:
                            form_type: Symfony\Component\Form\Extension\Core\Type\CheckboxType
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                        additional_data:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            continue_to_request_approval:
                step_to: request_approval
                transition_definition: continue_to_request_approval_definition
                is_unavailable_hidden: true
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        remove_source: ~
                        po_number: ~
                        ship_until:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutShipUntilType
                            options:
                                checkout: $checkout
                        customer_notes:
                            form_type: Symfony\Component\Form\Extension\Core\Type\TextareaType
                            options:
                                data: $checkout.customerNotes
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            continue_to_approve_request:
                step_to: approve_request
                transition_definition: request_for_approve_order_definition
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        request_approval_notes:
                            form_type: Symfony\Component\Form\Extension\Core\Type\TextareaType
                            options:
                                data: $request_approval_notes
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType
                message_parameters:
                    '{{ value }}': $.data.order_approval_threshold

            verify_customer_consents:
                step_to: customer_consents
                transition_definition: verify_customer_consents_definition
                is_hidden: true
                frontend_options:
                    stop_propagation: true

            back_to_customer_consents:
                step_to: customer_consents
                transition_definition: clear_payment_method_and_recalculate_state_definition
                frontend_options:
                    is_checkout_back: true

            back_to_billing_address:
                step_to: enter_billing_address
                transition_definition: clear_payment_method_and_recalculate_state_definition
                frontend_options:
                    is_checkout_back: true

            back_to_shipping_address:
                step_to: enter_shipping_address
                transition_definition: clear_payment_method_and_recalculate_state_definition
                frontend_options:
                    is_checkout_back: true

            back_to_shipping_address_on_fail_address:
                step_to: enter_shipping_address
                transition_definition: unblock_and_recalculate_definition
                is_hidden: true

            back_to_shipping_method:
                step_to: enter_shipping_method
                transition_definition: back_to_shipping_method_definition
                frontend_options:
                    is_checkout_back: true

            back_to_payment:
                step_to: enter_payment
                transition_definition: recalculate_state_definition
                frontend_options:
                    is_checkout_back: true

            verify_payment:
                step_to: enter_payment
                transition_definition: verify_payment_definition
                is_hidden: true
                frontend_options:
                    is_checkout_verify: true

            back_to_order_review:
                step_to: order_review
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            back_to_request_approval:
                step_to: request_approval
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            place_order:
                step_to: order_review
                transition_definition: place_order_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        remove_source: ~
                        po_number: ~
                        ship_until:
                            form_type: Oro\Bundle\CheckoutBundle\Form\Type\CheckoutShipUntilType
                            options:
                                checkout: $checkout
                        customer_notes:
                            form_type: Symfony\Component\Form\Extension\Core\Type\TextareaType
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            place_order_with_inactive_possibility:
                step_to: approve_request
                transition_definition: place_order_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        remove_source: ~
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            approve_order:
                step_to: approve_request
                transition_definition: approve_order_definition
                is_unavailable_hidden: true
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@tree':
                            conditions:
                                '@blank': $.result.shippingPriceUpdated
                            actions:
                                - '@assign_value': [$.result.shippingPriceUpdated, true]
                                - '@run_action_group':
                                    action_group: oro_update_shipping_price
                                    parameters_mapping:
                                        checkout: $checkout
                        - '@run_action_group':
                            action_group: update_checkout_state
                            parameters_mapping:
                                checkout: $checkout
                                state_token: $state_token
                                update_checkout_state: $.result.updateCheckoutState
                            results:
                                result.updateCheckoutState: $.update_checkout_state
                    attribute_fields:
                        state_token:
                            form_type: Symfony\Component\Form\Extension\Core\Type\HiddenType

            finish_checkout:
                step_to: order_created
                transition_definition: finish_checkout_definition
                is_hidden: true

            payment_error:
                step_to: enter_payment
                transition_definition: payment_error_definition
                is_hidden: true

        transition_definitions:
            start_from_quickorderform_definition:
                preactions:
                    - '@call_service_method':
                       conditions:
                           '@blank': $.result.isAllowed
                       parameters:
                            attribute: $.result.isAllowed
                            service: oro_shopping_list.processor.quick_add_to_checkout
                            method: isAllowed
                    - '@call_service_method':
                       conditions:
                           '@blank': $.result.isReachedLimit
                       parameters:
                           attribute: $.result.isReachedLimit
                           service: oro_shopping_list.manager.shopping_list_limit
                           method: isReachedLimit
                    - '@call_service_method':
                       conditions:
                           '@blank': $.result.shoppingListLimit
                       parameters:
                           attribute: $.result.shoppingListLimit
                           service: oro_shopping_list.manager.shopping_list_limit
                           method: getShoppingListLimitForUser
                    - '@call_service_method':
                       conditions:
                           '@blank': $.result.isCurrentShoppingListEmpty
                       parameters:
                           service: oro_shopping_list.manager.current_shopping_list
                           method: isCurrentShoppingListEmpty
                           attribute: $.result.isCurrentShoppingListEmpty
                    - '@assign_value': [$.result.doShowConfirmation, false]
                    - '@assign_value':
                        conditions:
                          '@and':
                            - '@equal': [$.result.isReachedLimit, true]
                            - '@equal': [$.result.isCurrentShoppingListEmpty, false]
                        parameters: [$.result.doShowConfirmation, true]
                    - '@delete_checkout_state':
                        conditions:
                            '@not_blank': $state_token
                        parameters:
                            entity: $checkout
                            token: $state_token

                preconditions:
                    '@equal': [true, $.result.isAllowed]

            start_from_shoppinglist_definition:
                preactions:
                    - '@find_entity':
                        conditions:
                            '@and':
                                - '@not_blank': $init_context
                                - '@blank': $.result.shoppingList
                        parameters:
                            class: $init_context.entityClass
                            identifier: $init_context.entityId
                            attribute: $.result.shoppingList
                    - '@tree':
                        conditions:
                            '@and':
                                - '@not_blank': $.result.shoppingList
                                - '@blank': $.result.extendableConditionShoppingListStart
                        actions:
                            - '@assign_value': [$.result.extendableConditionShoppingListStart, false]
                            - '@assign_value':
                                conditions:
                                    '@extendable':
                                        events: [extendable_condition.shopping_list_start]
                                parameters: [$.result.extendableConditionShoppingListStart, true]
                    - '@call_service_method':
                        conditions:
                            '@and':
                                - '@not_blank': $.result.shoppingList
                                - '@blank': $.result.shoppingListHasEmptyMatrix
                        parameters:
                            service: oro_shopping_list.manager.empty_matrix_grid
                            method: hasEmptyMatrix
                            method_parameters: [$.result.shoppingList]
                            attribute: $.result.shoppingListHasEmptyMatrix

                preconditions:
                   '@and':
                       - '@not_empty': $.result.shoppingList
                       - '@has_elements': $.result.shoppingList.lineItems
                       - '@equal': [$.result.extendableConditionShoppingListStart, true]

                actions:
                    - '@run_action_group':
                        action_group: start_shoppinglist_checkout
                        parameters_mapping:
                            shoppingList: $.result.shoppingList
                            showErrors: true
                        results:
                            data.checkout: $.checkout
                            result.redirectUrl: $.redirectUrl
                    - '@delete_checkout_state':
                        conditions:
                            '@not_blank': $state_token
                        parameters:
                            entity: $checkout
                            token: $state_token

            __start___definition:
                actions:
                    - '@assign_value': [$shipping_method, null]
                    - '@assign_value': [$payment_save_for_later, true]
                    - '@generate_uuid':
                        conditions:
                            '@blank': $state_token
                        parameters:
                          attribute: $state_token

            go_back_definition:
                actions:
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@assign_value': [$allowed, false]
                    - '@generate_uuid': $state_token

            verify_customer_consents_definition:
                preactions:
                    - '@tree':
                        conditions:
                            '@blank': $.result.isConsentsAccepted
                        actions:
                            - '@assign_value': [$.result.isConsentsAccepted, false]
                            - '@assign_value':
                                conditions:
                                    '@is_consents_accepted':
                                        acceptedConsents: $customerConsents
                                parameters: [$.result.isConsentsAccepted, true]
                    - '@flash_message':
                        conditions:
                            '@and':
                                - '@equal': [$.result.isConsentsAccepted, false]
                                - '@equal': [$consents_available, true]
                        message: oro.checkout.workflow.condition.required_consents_should_be_checked.message
                        type: 'warning'

                preconditions:
                    '@equal': [$.result.isConsentsAccepted, false]

            continue_to_billing_address_definition:
                preactions:
                    - '@assign_value': [$consents_available, true]

                actions:
                    - '@save_accepted_consents':
                        acceptedConsents: $customerConsents
                    - '@generate_uuid': $state_token

            continue_to_shipping_address_definition:
                preactions:
                    - '@run_action_group':
                        action_group: order_line_items_not_empty
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                    - '@tree':
                        conditions:
                            '@blank': $.result.extendableConditionCheckout
                        actions:
                            - '@assign_value': [$.result.extendableConditionCheckout, false]
                            - '@assign_value':
                                conditions:
                                    '@extendable':
                                        events: [extendable_condition.checkout]
                                parameters: [$.result.extendableConditionCheckout, true]

                preconditions:
                    '@and':
                        - '@equal': [$checkout.completed, false]
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmptyForRfp, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_not_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmpty, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_allow_rfp.message
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@equal': [$.result.extendableConditionCheckout, true]

                conditions:
                    '@and':
                        - '@is_checkout_state_valid':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                token: $state_token
                                current_state: $.result.currentCheckoutState
                        - '@not_empty': $checkout.billingAddress

                actions:
                    - '@run_action_group':
                        action_group: b2b_flow_checkout_update_billing_address
                        parameters_mapping:
                          checkout: $checkout
                          disallow_shipping_address_edit: $disallow_shipping_address_edit
                        results:
                          data.billing_address_has_shipping: $.billing_address_has_shipping
                    - '@save_accepted_consents':
                        acceptedConsents: $customerConsents
                    # Disables state checking in inner transition to continue_to_shipping_method.
                    - '@generate_uuid': $state_token
                    - '@tree':
                        conditions:
                            '@equal': [true, $ship_to_billing_address]
                        actions:
                            - '@transit_workflow':
                                entity: $checkout
                                transition: continue_to_shipping_method
                                workflow: $.workflowName

            continue_to_shipping_method_definition:
                preactions:
                    - '@run_action_group':
                        action_group: order_line_items_not_empty
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp

                preconditions:
                    '@and':
                        - '@equal': [$checkout.completed, false]
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmptyForRfp, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_not_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmpty, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_allow_rfp.message
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                conditions:
                    '@and':
                        - '@is_checkout_state_valid':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                token: $state_token
                                current_state: $.result.currentCheckoutState
                        - '@or':
                            - '@equal': [$checkout.shipToBillingAddress, true]
                            - '@and':
                                - '@equal': [$checkout.shipToBillingAddress, false]
                                - '@not_empty': $checkout.shippingAddress

                actions:
                    - '@run_action_group':
                        action_group: b2b_flow_checkout_update_shipping_address
                        parameters_mapping:
                            checkout: $checkout
                    - '@call_service_method':
                        service: oro_checkout.action.default_shipping_method_setter
                        method: setDefaultShippingMethod
                        method_parameters: [$checkout]
                    - '@generate_uuid': $state_token

            continue_to_payment_definition:
                preactions:
                    - '@run_action_group':
                        action_group: order_line_items_not_empty
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                    - '@call_service_method':
                          service: oro_checkout.action.default_shipping_method_setter
                          method: setDefaultShippingMethod
                          method_parameters: [$checkout]
                    - '@tree':
                        conditions:
                            '@blank': $.result.checkoutHasApplicableShippingMethods
                        actions:
                            - '@assign_value': [$.result.checkoutHasApplicableShippingMethods, false]
                            - '@assign_value':
                                conditions:
                                    '@checkout_has_applicable_shipping_methods': $checkout
                                parameters: [$.result.checkoutHasApplicableShippingMethods, true]

                preconditions:
                    '@and':
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmptyForRfp, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_not_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmpty, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.checkoutHasApplicableShippingMethods, true]
                            message: oro.checkout.workflow.condition.shipping_method_is_not_available.message
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                actions:
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@assign_value': [$.result.shippingPriceUpdated, true]
                    - '@generate_uuid': $state_token

            continue_to_order_review_definition:
                preactions:
                    - '@run_action_group':
                        action_group: order_line_items_not_empty
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                    - '@tree':
                        conditions:
                            '@blank': $.result.shippingMethodHasEnabledShippingRules
                        actions:
                            - '@assign_value': [$.result.shippingMethodHasEnabledShippingRules, false]
                            - '@assign_value':
                                conditions:
                                    '@shipping_method_has_enabled_shipping_rules': $checkout.shippingMethod
                                parameters: [$.result.shippingMethodHasEnabledShippingRules, true]
                    - '@call_service_method':
                        conditions:
                            '@blank': $.result.paymentContext
                        parameters:
                            service: oro_checkout.provider.payment_context
                            method: getContext
                            method_parameters: [$checkout]
                            attribute: $.result.paymentContext
                    - '@tree':
                        conditions:
                            '@blank': $.result.hasApplicablePaymentMethods
                        actions:
                            - '@assign_value': [$.result.hasApplicablePaymentMethods, false]
                            - '@assign_value':
                                conditions:
                                    '@has_applicable_payment_methods': $.result.paymentContext
                                parameters: [$.result.hasApplicablePaymentMethods, true]

                preconditions:
                    '@and':
                        - '@equal': [$checkout.completed, false]
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmptyForRfp, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_not_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmpty, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.shippingMethodHasEnabledShippingRules, true]
                            message: oro.checkout.workflow.condition.shipping_method_is_not_available.message
                        - '@equal':
                            parameters: [$.result.hasApplicablePaymentMethods, true]
                            message: oro.checkout.workflow.condition.payment_method_is_not_applicable.message
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                conditions:
                    '@and':
                        - '@check_request':
                            message: oro.checkout.workflow.condition.invalid_request.message
                            parameters:
                                is_ajax: true
                                expected_key: _wid
                                expected_value: ajax_checkout
                        - '@is_checkout_state_valid':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                token: $state_token
                                current_state: $.result.currentCheckoutState
                        - '@not_empty':
                            message: oro.checkout.workflow.condition.payment_method_was_not_selected.message
                            parameters: $checkout.paymentMethod
                        - '@payment_method_applicable':
                            message: oro.checkout.workflow.condition.payment_method_is_not_applicable.message
                            payment_method: $checkout.paymentMethod
                            context: $.result.paymentContext

                actions:
                    - '@tree':
                        conditions:
                            '@equal': [$payment_validate, true]
                        actions:
                            - '@assign_constant_value': [$.result.validateAction, Oro\Bundle\PaymentBundle\Method\PaymentMethodInterface::VALIDATE]
                            - '@assign_url':
                                attribute: $.result.successUrl
                                route: oro_checkout_frontend_checkout
                                route_parameters:
                                    id: $checkout.id
                            - '@assign_url':
                                attribute: $.result.failureUrl
                                route: oro_checkout_frontend_checkout
                                route_parameters:
                                    id: $checkout.id
                                    transition: 'payment_error'
                            - '@payment_validate':
                                conditions:
                                    '@payment_method_supports':
                                        payment_method: $checkout.paymentMethod
                                        action: $.result.validateAction
                                attribute: $.result.responseData
                                object: $checkout
                                paymentMethod: $checkout.paymentMethod
                                transactionOptions:
                                    saveForLaterUse: $payment_save_for_later
                                    successUrl: $.result.successUrl
                                    failureUrl: $.result.failureUrl
                                    additionalData: $additional_data
                                    checkoutId: $checkout.id
                    - '@generate_uuid': $state_token

            verify_payment_definition:
                preactions:
                    - '@run_action_group':
                        action_group: order_line_items_not_empty
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            result.orderLineItemsNotEmpty: $.orderLineItemsNotEmpty
                            result.orderLineItemsNotEmptyForRfp: $.orderLineItemsNotEmptyForRfp
                    - '@tree':
                        conditions:
                            '@blank': $.result.requirePaymentRedirect
                        actions:
                            - '@assign_value': [$.result.requirePaymentRedirect, false]
                            - '@assign_value':
                                conditions:
                                    '@require_payment_redirect':
                                        payment_method: $payment_method
                                parameters: [$.result.requirePaymentRedirect, true]

                preconditions:
                    '@and':
                        - '@or':
                            - '@not':
                                - '@check_request':
                                    is_ajax: true
                                    expected_key: _wid
                                    expected_value: ajax_checkout
                            - '@not':
                                - '@check_request':
                                    is_ajax: true
                                    expected_key: transition
                                    expected_value: continue_to_order_review
                        - '@equal': [$checkout.completed, false]
                        - '@equal': [$payment_in_progress, false]
                        - '@equal': [$.result.requirePaymentRedirect, true]
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmptyForRfp, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_not_allow_rfp.message
                        - '@equal':
                            parameters: [$.result.orderLineItemsNotEmpty, true]
                            message: oro.checkout.workflow.condition.order_line_item_has_count_allow_rfp.message

                actions:
                    - '@generate_uuid': $state_token

            place_order_definition:
                preactions:
                    - '@flash_message':
                        conditions:
                            '@and':
                                - '@equal': [$payment_in_progress, true]
                                - '@equal': [$checkout.completed, false]
                        message: oro.checkout.workflow.condition.payment_has_not_been_processed.message
                        type: 'warning'
                    - '@tree':
                        conditions:
                            '@not_empty': [$.id]
                        actions:
                            - '@call_service_method':
                                conditions:
                                    '@empty': $.result.paymentContext
                                parameters:
                                    service: oro_checkout.provider.payment_context
                                    method: getContext
                                    method_parameters: [$checkout]
                                    attribute: $.result.paymentContext
                    - '@tree':
                        conditions:
                            '@blank': $.result.shippingMethodHasEnabledShippingRules
                        actions:
                            - '@assign_value': [$.result.shippingMethodHasEnabledShippingRules, false]
                            - '@assign_value':
                                conditions:
                                    '@shipping_method_has_enabled_shipping_rules': $checkout.shippingMethod
                                parameters: [$.result.shippingMethodHasEnabledShippingRules, true]
                    - '@tree':
                        conditions:
                            '@blank': $.result.paymentMethodApplicable
                        actions:
                            - '@assign_value': [$.result.paymentMethodApplicable, false]
                            - '@assign_value':
                                conditions:
                                    '@payment_method_applicable':
                                        payment_method: $checkout.paymentMethod
                                        context: $.result.paymentContext
                                parameters: [$.result.paymentMethodApplicable, true]
                    - '@tree':
                        conditions:
                            '@blank': $.result.extendableConditionCheckout
                        actions:
                            - '@assign_value': [$.result.extendableConditionCheckout, false]
                            - '@assign_value':
                                conditions:
                                    '@extendable':
                                        events: ['extendable_condition.checkout']
                                parameters: [$.result.extendableConditionCheckout, true]
                    - '@tree':
                        conditions:
                            '@blank': $.result.extendableConditionPreOrderCreate
                        actions:
                            - '@assign_value': [$.result.extendableConditionPreOrderCreate, false]
                            - '@assign_value':
                                conditions:
                                    '@extendable':
                                        events: ['extendable_condition.pre_order_create']
                                parameters: [$.result.extendableConditionPreOrderCreate, true]
                    - '@tree':
                        conditions:
                            '@blank': $.result.lessOrderTotalLimit
                        actions:
                            - '@assign_value': [$.result.lessOrderTotalLimit, false]
                            - '@assign_value':
                                conditions:
                                    '@less_order_total_limit': [$checkout, $.data.order_approval_threshold]
                                parameters: [$.result.lessOrderTotalLimit, true]

                preconditions:
                    '@and':
                        - '@not_empty': $.result.paymentContext
                        - '@equal':
                            parameters: [$.result.shippingMethodHasEnabledShippingRules, true]
                            message: oro.checkout.workflow.condition.shipping_method_is_not_available.message
                        - '@equal':
                            parameters: [$.result.paymentMethodApplicable, true]
                            message: oro.checkout.workflow.condition.payment_method_is_not_applicable.message
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@or':
                            message: "Pending approval"
                            parameters:
                                - '@equal': [$.result.lessOrderTotalLimit, true]
                                - '@equal': [$allowed, true]
                                - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                        - '@equal': [$.result.extendableConditionCheckout, true]
                        - '@equal': [$.result.extendableConditionPreOrderCreate, true]

                conditions:
                    '@and':
                        - '@is_checkout_state_valid':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                token: $state_token
                                current_state: $.result.currentCheckoutState
                        - '@extendable':
                            message: 'oro.checkout.workflow.b2b_flow_checkout.transition.place_order.condition.extendable.message'
                            events:
                                - 'extendable_condition.before_order_create'

                actions:
                    - '@assign_constant_value': [$.result.validateAction, Oro\Bundle\PaymentBundle\Method\PaymentMethodInterface::VALIDATE]

                    - '@assign_url':
                        attribute: $.result.failedShippingAddressUrl
                        route: oro_checkout_frontend_checkout
                        route_parameters:
                            id: $checkout.id
                            transition: 'back_to_shipping_address_on_fail_address'

                    - '@run_action_group':
                        action_group: b2b_flow_checkout_place_order
                        parameters_mapping:
                            checkout: $checkout
                        results:
                            data.order: $.order

                    - '@assign_value': [$payment_in_progress, true]

                    - '@run_action_group':
                        action_group: b2b_flow_checkout_purchase
                        parameters_mapping:
                            checkout: $checkout
                            order: $order
                            transactionOptions:
                                failedShippingAddressUrl: $.result.failedShippingAddressUrl
                                additionalData: $additional_data
                        results:
                            result.responseData: $.responseData

                    - '@extendable':
                        events: [extendable_action.finish_checkout]

                    - '@redirect':
                        conditions:
                            '@and':
                                - '@equal':
                                    - $.result.responseData[purchaseSuccessful]
                                    - true
                                - '@payment_method_supports':
                                    payment_method: $checkout.paymentMethod
                                    action: $.result.validateAction
                        route: oro_checkout_frontend_checkout
                        route_parameters:
                            id: $checkout.id
                            transition: finish_checkout

                    - '@redirect':
                        conditions:
                            '@and':
                                - '@equal':
                                    - $.result.responseData[purchaseSuccessful]
                                    - false
                                - '@payment_method_supports':
                                    payment_method: $checkout.paymentMethod
                                    action: $.result.validateAction
                        route: oro_checkout_frontend_checkout
                        route_parameters:
                            id: $checkout.id
                            transition: payment_error
                    - '@generate_uuid': $state_token

            continue_to_request_approval_definition:
                preactions:
                    - '@tree':
                        conditions:
                            '@blank': $.result.lessOrderTotalLimit
                        actions:
                            - '@assign_value': [$.result.lessOrderTotalLimit, false]
                            - '@assign_value':
                                conditions:
                                    '@less_order_total_limit': [$checkout, $.data.order_approval_threshold]
                                parameters: [$.result.lessOrderTotalLimit, true]

                preconditions:
                    '@and':
                        - '@equal': [$.result.lessOrderTotalLimit, false]
                        - '@equal': [$allowed, false]
                        - '@not':
                            - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                conditions:
                    '@is_checkout_state_valid':
                        message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                        parameters:
                            entity: $checkout
                            token: $state_token
                            current_state: $.result.currentCheckoutState

                actions:
                    - '@generate_uuid': $state_token

            request_for_approve_order_definition:
                conditions:
                    '@and':
                        - '@is_checkout_state_valid':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                token: $state_token
                                current_state: $.result.currentCheckoutState
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                actions:
                    - '@assign_value':
                        conditions:
                            '@equal': [$requested_for_approve, false]
                        parameters: [$requested_for_approve, true]
                    - '@generate_uuid': $state_token

            approve_order_definition:
                preconditions:
                    '@and':
                        - '@equal': [$allowed, false]
                        - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                        - '@quote_acceptable': [$checkout.sourceEntity, true]

                conditions:
                    '@is_checkout_state_valid':
                        message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                        parameters:
                            entity: $checkout
                            token: $state_token
                            current_state: $.result.currentCheckoutState

                actions:
                    - '@assign_value': [$allowed, true]
                    - '@create_datetime':
                        attribute: $allow_request_date
                    - '@generate_uuid': $state_token

            finish_checkout_definition:
                conditions:
                    '@and':
                        - '@not_empty': [$order]
                        - '@equal': [$payment_in_progress, true]

                actions:
                    - '@run_action_group':
                        action_group: b2b_flow_checkout_finish_checkout
                        parameters_mapping:
                            checkout: $checkout
                            order: $order
                            auto_remove_source: $auto_remove_source
                            allow_manual_source_remove: $allow_manual_source_remove
                            remove_source: $remove_source
                            clear_source: $clear_source

                    - '@delete_checkout_state':
                          entity: $checkout

            recalculate_state_definition:
                preconditions:
                    '@equal': [$checkout.completed, false]

                actions:
                    - '@run_action_group':
                          action_group: oro_update_shipping_price
                          parameters_mapping:
                              checkout: $checkout
                    - '@assign_value':
                        - [$.result.shippingPriceUpdated, true]
                        - [$payment_in_progress, false]
                    - '@generate_uuid': $state_token

            back_to_shipping_method_definition:
                preconditions:
                    '@equal': [$checkout.completed, false]

                actions:
                    - '@assign_value':
                        - [$payment_method, null]
                        - [$payment_in_progress, false]
                        - [$shipping_method, null]
                        - [$checkout.shippingCost, null]
                    - '@call_service_method':
                        service: oro_checkout.action.default_shipping_method_setter
                        method: setDefaultShippingMethod
                        method_parameters: [$checkout]
                    - '@generate_uuid': $state_token

            clear_payment_method_and_recalculate_state_definition:
                preconditions:
                    '@equal': [$checkout.completed, false]

                actions:
                    - '@assign_value':
                        - [$payment_method, null]
                        - [$payment_in_progress, false]
                        - [$shipping_method, null]
                        - [$checkout.shippingCost, null]
                    - '@generate_uuid': $state_token

            unblock_and_recalculate_definition:
                actions:
                    - '@assign_value':
                        - [$payment_method, null]
                        - [$payment_in_progress, false]
                    - '@generate_uuid': $state_token


            payment_error_definition:
                actions:
                    - '@assign_value':
                          - [$payment_method, null]
                          - [$payment_in_progress, false]
                    - '@remove_entity':
                        conditions:
                            '@not_empty': $order
                        parameters: [$order]
                    - '@unset_value': [$.data.order]
                    - '@generate_uuid': $state_token
