workflows:
    b2b_flow_alternative_checkout:
        entity: Oro\Bundle\CheckoutBundle\Entity\Checkout
        entity_attribute: checkout
        steps_display_ordered: true

        defaults:
            active: false
        exclusive_record_groups:
            - b2b_checkout_flow
        priority: 100

        scopes:
            -
                customer: 4

        applications: ['commerce']

        variable_definitions:
            variables:
                order_approval_threshold:
                    type: 'float'
                    value: 5000
                    options:
                        form_options:
                            tooltip: true

        attributes:
            billing_address:
                property_path: checkout.billingAddress
            shipping_address:
                property_path: checkout.shippingAddress
            save_billing_address:
                property_path: checkout.saveBillingAddress
            save_shipping_address:
                property_path: checkout.saveShippingAddress
            ship_to_billing_address:
                property_path: checkout.shipToBillingAddress
            po_number:
                property_path: checkout.poNumber
            ship_until:
                property_path: checkout.shipUntil
            customer_notes:
                property_path: checkout.customerNotes
            payment_method:
                property_path: checkout.paymentMethod
            shipping_method:
                property_path: checkout.shippingMethod
            shipping_method_type:
                property_path: checkout.shippingMethodType
            request_approval_notes:
                type: string
            billing_address_has_shipping:
                type: boolean
            allow_manual_source_remove:
                type: boolean
            disallow_billing_address_edit:
                type: boolean
            disallow_shipping_address_edit:
                type: boolean
            disallow_shipping_method_edit:
                type: boolean
            remove_source:
                type: boolean
            auto_remove_source:
                type: boolean
            source_remove_label:
                type: string
            edit_order_link:
                type: string
            allowed:
                type: bool
            allow_request_date:
                type: object
                options:
                    class: DateTime
            requested_for_approve:
                type: bool
            state_token:
                type: string
            internal_state_token:
                type: string
            order:
                type: entity
                options:
                    class: Oro\Bundle\OrderBundle\Entity\Order
        steps:
            enter_billing_address:
                order: 10
                allowed_transitions:
                    - continue_to_shipping_address
            enter_shipping_address:
                order: 20
                allowed_transitions:
                    - continue_to_shipping_method
                    - back_to_billing_address
            enter_shipping_method:
                order: 30
                allowed_transitions:
                    - continue_to_payment
                    - back_to_billing_address
                    - back_to_shipping_address
            enter_payment:
                order: 40
                allowed_transitions:
                    - continue_to_order_review
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
            order_review:
                order: 50
                allowed_transitions:
                    - continue_to_request_approval
                    - place_order
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
            request_approval:
                order: 60
                allowed_transitions:
                    - continue_to_approve_request
                    - back_to_billing_address
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
                    - back_to_order_review
            approve_request:
                order: 70
                allowed_transitions:
                    - approve_order
                    - place_order_with_inactive_possibility
                    - back_to_billing_address
                    - back_to_billing_address
                    - back_to_shipping_address
                    - back_to_shipping_method
                    - back_to_payment
                    - back_to_order_review
                    - back_to_request_approval
            order_created:
                order: 80
                is_final: true

        transitions:
            __start__:
                is_start: true
                is_hidden: true
                step_to: enter_billing_address
                transition_definition: __start___definition
            start_from_shoppinglist:
                is_start: true
                step_to: enter_billing_address
                is_unavailable_hidden: true
                transition_definition: start_from_shoppinglist_definition
                frontend_options:
                    icon: fa-briefcase
                init_routes:
                    - oro_shopping_list_frontend_view
                acl_resource: [CHECKOUT_CREATE, $.result.shoppingList]

            start_from_quickorderform:
                is_start: true
                step_to: enter_billing_address
                is_unavailable_hidden: true
                transition_definition: start_from_quickorderform_definition
                frontend_options:
                    icon: fa-briefcase
                    class: 'btn--action'
                    data:
                        component_name: oro_shopping_list_to_checkout_quick_add_processor
                        page-component-module: oroproduct/js/app/components/quick-add-form-button-component
                        page-component-options:
                            component_name: '[name$="[component]"]'
                init_routes:
                    - oro_product_frontend_quick_add
                    - oro_product_frontend_quick_add_copy_paste
                    - oro_product_frontend_quick_add_import
                acl_resource: [CREATE, entity:commerce@Oro\Bundle\CheckoutBundle\Entity\Checkout]

            continue_to_shipping_address:
                step_to: enter_shipping_address
                transition_definition: continue_to_shipping_address_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        billing_address:
                            form_type: oro_checkout_address
                            options:
                                object: $checkout
                                isEditEnabled: true
                                addressType: 'billing'
                                required: true
                                constraints:
                                    - Valid: ~
                                    - Oro\Bundle\OrderBundle\Validator\Constraints\OrderAddress:
                                        validationGroups: ['Default', 'Frontend', 'PersonInfo']
                                disabled: $disallow_billing_address_edit
                        save_billing_address:
                            options:
                        ship_to_billing_address:
                            form_type: oro_ship_to_billing_address
                            options:
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

            continue_to_shipping_method:
                step_to: enter_shipping_method
                transition_definition: continue_to_shipping_method_definition
                display_type: page
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        shipping_address:
                            form_type: oro_checkout_address
                            options:
                                object: $checkout
                                isEditEnabled: true
                                addressType: 'shipping'
                                required: true
                                disabled: $disallow_shipping_address_edit
                                constraints:
                                    - Valid: ~
                                    - NotBlank: ~
                                    - Oro\Bundle\OrderBundle\Validator\Constraints\OrderAddress:
                                        validationGroups: ['Checkout']
                        save_shipping_address:
                            options:
                        ship_to_billing_address:
                            form_type: oro_ship_to_billing_address
                            options:
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

            continue_to_payment:
                step_to: enter_payment
                transition_definition: continue_to_payment_definition
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                    page_component_module: 'orocheckout/js/app/components/shipping-transition-button-component'
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                        - '@call_service_method':
                            service: oro_checkout.action.default_shipping_method_setter
                            method: setDefaultShippingMethod
                            method_parameters: [$checkout]
                    attribute_fields:
                        shipping_method:
                            options:
                                constraints:
                                    - NotBlank: ~
                        shipping_method_type:
                            options:
                                constraints:
                                    - NotBlank: ~
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

            continue_to_order_review:
                step_to: order_review
                transition_definition: continue_to_order_review_definition
                frontend_options:
                    is_checkout_continue: true
                    is_checkout_show_errors: true
                form_options:
                    form_init:
                        - '@assign_constant_value': [$payment_method, 'Oro\Bundle\PaymentTermBundle\Method\PaymentTerm::TYPE']
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        payment_method: ~
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token
            continue_to_request_approval:
                step_to: request_approval
                transition_definition: continue_to_request_approval_definition
                is_unavailable_hidden: true
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        remove_source: ~
                        po_number: ~
                        ship_until: ~
                        customer_notes:
                            form_type: textarea
                            options:
                                data: $checkout.customerNotes
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

            continue_to_approve_request:
                step_to: approve_request
                transition_definition: request_for_approve_order_definition
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        request_approval_notes:
                            form_type: textarea
                            options:
                                data: $request_approval_notes
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

            back_to_billing_address:
                step_to: enter_billing_address
                transition_definition: back_to_billing_address_definition
                frontend_options:
                    is_checkout_back: true

            back_to_shipping_address:
                step_to: enter_shipping_address
                transition_definition: back_to_shipping_address_definition
                frontend_options:
                    is_checkout_back: true

            back_to_shipping_method:
                step_to: enter_shipping_method
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            back_to_payment:
                step_to: enter_payment
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            back_to_order_review:
                step_to: order_review
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            back_to_request_approval:
                step_to: request_approval
                transition_definition: go_back_definition
                frontend_options:
                    is_checkout_back: true

            place_order:
                step_to: order_created
                transition_definition: place_order_definition
                display_type: page
                is_unavailable_hidden: true
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    attribute_fields:
                        remove_source: ~
                        po_number: ~
                        ship_until: ~
                        customer_notes:
                            form_type: textarea

            place_order_with_inactive_possibility:
                step_to: order_created
                transition_definition: place_order_definition
                display_type: page
                is_unavailable_hidden: false
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        po_number: ~
                        ship_until: ~
                        customer_notes:
                            form_type: textarea
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token
            approve_order:
                step_to: approve_request
                transition_definition: approve_order_definition
                is_unavailable_hidden: true
                frontend_options:
                    is_checkout_continue: true
                form_options:
                    form_init:
                        - '@generate_checkout_state_snapshot':
                            entity: $checkout
                            attribute: $.result.initCheckoutState
                    attribute_fields:
                        state_token:
                            form_type: hidden
                            options:
                                data: $internal_state_token

        transition_definitions:
            start_from_quickorderform_definition:
                preactions:
                    - '@call_service_method':
                        attribute: $.result.isAllowed
                        service: oro_shopping_list.processor.quick_add_to_checkout
                        method: isAllowed
                preconditions:
                    '@and':
                        - '@not_empty': $init_context
                        - '@equal': [true, $.result.isAllowed]

            start_from_shoppinglist_definition:
                preactions:
                    - '@find_entity':
                        conditions:
                            '@not_empty': $init_context
                        parameters:
                            class: $init_context.entityClass
                            identifier: $init_context.entityId
                            attribute: $.result.shoppingList
                preconditions:
                    '@has_elements': $.result.shoppingList.lineItems
                actions:
                    - '@run_action_group':
                        action_group: start_shoppinglist_checkout
                        parameters_mapping:
                            shoppingList: $.result.shoppingList
                            showErrors: true
                        results:
                            data.checkout: $.checkout
                            result.redirectUrl: $.redirectUrl

            __start___definition:
                actions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.startCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.startCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]
            do_nothing: ~
            go_back_definition:
                actions:
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@assign_value':
                        conditions:
                            '@equal': [$allowed, true]
                        parameters: [$allowed, false]
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]
            back_to_shipping_address_definition:
                actions:
                    - '@assign_value': [$shipping_method, null]
                    - '@assign_value': [$checkout.shippingCost, null]
                    - '@assign_value': [$allowed, false]
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]
            back_to_billing_address_definition:
                actions:
                    - '@assign_value': [$billing_address_has_shipping, true]
                    - '@assign_value': [$shipping_method, null]
                    - '@assign_value': [$checkout.shippingCost, null]
                    - '@assign_value': [$allowed, false]
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]
            continue_to_shipping_address_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                preconditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@extendable':
                            events: [extendable_condition.checkout]
                        - '@order_line_item_has_count':
                            message: oro.checkout.workflow.condition.order_line_item_has_count.message
                            parameters:
                                entity: $checkout
                conditions:
                    '@and':
                        - '@not_empty': $checkout.billingAddress
                        - '@not_empty': $.result.initCheckoutState
                        - '@or':
                            - '@empty': $.result.savedCheckoutState
                            - '@check_checkout_states':
                                message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                                parameters:
                                    entity: $checkout
                                    state1: $.result.initCheckoutState
                                    state2: $.result.savedCheckoutState
                actions:
                    - '@assign_constant_value': [$.result.typeShippingName, Oro\Bundle\AddressBundle\Entity\AddressType::TYPE_SHIPPING]
                    - '@call_method':
                        conditions:
                            '@not_empty': $checkout.billingAddress.customerAddress
                        parameters:
                            attribute: $billing_address_has_shipping
                            object: $checkout.billingAddress.customerAddress
                            method: hasTypeWithName
                            method_parameters:
                                - $.result.typeShippingName
                    - '@call_method':
                        conditions:
                            '@not_empty': $checkout.billingAddress.customerUserAddress
                        parameters:
                            attribute: $billing_address_has_shipping
                            object: $checkout.billingAddress.customerUserAddress
                            method: hasTypeWithName
                            method_parameters:
                                - $.result.typeShippingName
                    - '@assign_value':
                        conditions:
                            '@and':
                                - '@empty': $checkout.billingAddress.customerAddress
                                - '@empty': $checkout.billingAddress.customerUserAddress
                        parameters: [$billing_address_has_shipping, true]
                    - '@tree':
                        conditions:
                            '@and':
                                - '@equal': [$disallow_shipping_address_edit, false]
                                - '@equal': [$checkout.shipToBillingAddress, true]
                                - '@equal': [$billing_address_has_shipping, true]
                        actions:
                            - '@remove_entity':
                                conditions:
                                    '@not_empty': $checkout.shippingAddress
                                parameters: [$checkout.shippingAddress]
                            - '@duplicate':
                                target: $checkout.billingAddress
                                attribute: $checkout.shippingAddress
                                settings:
                                  - [[setNull], [propertyName, [id]]]
                                  - [[keep], [propertyName, [customerAddress]]]
                                  - [[keep], [propertyName, [customerUserAddress]]]
                                  - [[keep], [propertyName, [city]]]
                                  - [[keep], [propertyName, [country]]]
                                  - [[keep], [propertyName, [region]]]
                                  - [[keep], [propertyName, [organization]]]
                                  - [[shallowCopy], [propertyType, ['\DateTime']]]
                            - '@flush_entity': $checkout.shippingAddress
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            continue_to_shipping_method_definition:
                preactions:
                     - '@generate_checkout_state_snapshot':
                         entity: $checkout
                         attribute: $.result.currentCheckoutState
                     - '@get_checkout_state':
                         entity: $checkout
                         token: $state_token
                         attribute: $.result.tokenCheckoutState
                     - '@tree':
                         conditions:
                             '@not':
                                 - '@check_checkout_states':
                                     entity: $checkout
                                     state1: $.result.currentCheckoutState
                                     state2: $.result.tokenCheckoutState
                         actions:
                             - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                             - '@delete_checkout_state':
                                 entity: $checkout
                                 token: $state_token
                             - '@save_checkout_state':
                                 entity: $checkout
                                 state: $.result.currentCheckoutState
                                 token: $state_token
                preconditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@order_line_item_has_count':
                            message: oro.checkout.workflow.condition.order_line_item_has_count.message
                            parameters:
                                entity: $checkout
                conditions:
                    '@and':
                        - '@or':
                            - '@empty': $.result.savedCheckoutState
                            - '@check_checkout_states':
                                message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                                parameters:
                                    entity: $checkout
                                    state1: $.result.initCheckoutState
                                    state2: $.result.savedCheckoutState
                            - '@and':
                                - '@equal': [$billing_address_has_shipping, true]
                                - '@equal': [$checkout.shipToBillingAddress, true]
                            - '@and':
                                - '@equal': [$checkout.shipToBillingAddress, false]
                                - '@not_empty': $checkout.shippingAddress
                actions:
                    - '@tree':
                        conditions:
                            '@and':
                                - '@equal': [$checkout.shipToBillingAddress, true]
                                - '@equal': [$billing_address_has_shipping, true]
                        actions:
                            - '@remove_entity':
                                conditions:
                                    '@not_empty': $checkout.shippingAddress
                                parameters: [$checkout.shippingAddress]
                            - '@duplicate':
                                target: $checkout.billingAddress
                                attribute: $checkout.shippingAddress
                                settings:
                                  - [[setNull], [propertyName, [id]]]
                                  - [[keep], [propertyName, [customerAddress]]]
                                  - [[keep], [propertyName, [customerUserAddress]]]
                                  - [[keep], [propertyName, [city]]]
                                  - [[keep], [propertyName, [country]]]
                                  - [[keep], [propertyName, [region]]]
                                  - [[keep], [propertyName, [organization]]]
                                  - [[shallowCopy], [propertyType, ['\DateTime']]]
                            - '@flush_entity': $checkout.shippingAddress
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            continue_to_payment_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                    - '@call_service_method':
                        service: oro_checkout.factory.shipping_context_factory
                        method: create
                        method_parameters: [$checkout]
                        attribute: $.result.shippingContext
                preconditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@order_line_item_has_count':
                            message: oro.checkout.workflow.condition.order_line_item_has_count.message
                            parameters:
                                entity: $checkout
                        - '@checkout_has_applicable_shipping_methods':
                            checkout: $checkout
                conditions:
                    '@or':
                        - '@empty': $.result.savedCheckoutState
                        - '@check_checkout_states':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                state1: $.result.initCheckoutState
                                state2: $.result.savedCheckoutState
                actions:
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            place_order_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                preconditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@or':
                            message: "Pending approval"
                            parameters:
                                - '@less_order_total_limit': [$checkout, $.data.order_approval_threshold]
                                - '@equal': [$allowed, true]
                                - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                conditions:
                    '@and':
                        - '@extendable':
                            message: 'oro.checkout.workflow.b2b_flow_checkout.transition.place_order.condition.extendable.message'
                            events: ['extendable_condition.before_order_create']
                        - '@or':
                            - '@empty': $.result.savedCheckoutState
                            - '@check_checkout_states':
                                message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                                parameters:
                                    entity: $checkout
                                    state1: $.result.initCheckoutState
                                    state2: $.result.savedCheckoutState
                actions:
                    - '@assign_value':
                        conditions:
                            '@equal': [$checkout.shipToBillingAddress, false]
                        parameters: [$.result.shippingAddress, $checkout.shippingAddress]
                    - '@assign_value':
                        conditions:
                            '@equal': [$checkout.shipToBillingAddress, true]
                        parameters: [$.result.shippingAddress, $checkout.billingAddress]

                    # Place order
                    - '@get_class_name':
                        object: $checkout.sourceEntity.sourceDocument
                        attribute: $.result.sourceDocumentEntityClassName
                    - '@duplicate':
                        target: $checkout.billingAddress
                        attribute: $.result.billingAddress
                        settings:
                          - [[setNull], [propertyName, [id]]]
                          - [[keep], [propertyName, [customerAddress]]]
                          - [[keep], [propertyName, [customerUserAddress]]]
                          - [[keep], [propertyName, [city]]]
                          - [[keep], [propertyName, [country]]]
                          - [[keep], [propertyName, [region]]]
                          - [[keep], [propertyName, [organization]]]
                          - [[shallowCopy], [propertyType, ['\DateTime']]]
                    - '@flush_entity': $.result.billingAddress
                    - '@duplicate':
                        target: $.result.shippingAddress
                        attribute: $.result.shippingAddress
                        settings:
                          - [[setNull], [propertyName, [id]]]
                          - [[keep], [propertyName, [customerAddress]]]
                          - [[keep], [propertyName, [customerUserAddress]]]
                          - [[keep], [propertyName, [city]]]
                          - [[keep], [propertyName, [country]]]
                          - [[keep], [propertyName, [region]]]
                          - [[keep], [propertyName, [organization]]]
                          - [[shallowCopy], [propertyType, ['\DateTime']]]
                    - '@flush_entity': $.result.shippingAddress
                    - '@call_service_method':
                        service: oro_payment_term.provider.payment_term
                        method: getCurrentPaymentTerm
                        attribute: $.result.paymentTerm
                    - '@get_order_line_items':
                        attribute: $.result.lineItems
                        checkout: $checkout
                    - '@create_order':
                        attribute: $order
                        checkout: $checkout
                        data:
                            billingAddress: $.result.billingAddress
                            shippingAddress: $.result.shippingAddress
                            sourceEntityClass: $.result.sourceDocumentEntityClassName
                            paymentTerm: $.result.paymentTerm
                            lineItems: $.result.lineItems
                    - '@call_service_method':
                        service: oro_order.handler.order_totals_handler
                        method: fillSubtotals
                        method_parameters:
                            - $order
                    - '@flush_entity': $order

                    # Save billing address if required
                    - '@assign_constant_value': [$.result.typeBillingName, Oro\Bundle\AddressBundle\Entity\AddressType::TYPE_BILLING]
                    - '@tree':
                        conditions:
                            '@and':
                                - '@equal': [$checkout.saveBillingAddress, true]
                                - '@empty': $order.billingAddress.customerAddress
                                - '@empty': $order.billingAddress.customerUserAddress
                                - '@acl_granted': 'oro_order_address_billing_allow_manual'
                        actions:
                            - '@find_entity':
                                class: Oro\Bundle\AddressBundle\Entity\AddressType
                                attribute: $.result.typeBilling
                                identifier: $.result.typeBillingName
                            - '@create_entity':
                                attribute: $.result.customerBillingAddress
                                class: Oro\Bundle\CustomerBundle\Entity\CustomerUserAddress
                                data:
                                    frontendOwner: $checkout.customerUser
                                    owner: $checkout.owner
                                    systemOrganization: $checkout.organization
                                    label: $order.billingAddress.label
                                    organization: $order.billingAddress.organization
                                    street: $order.billingAddress.street
                                    street2: $order.billingAddress.street2
                                    city: $order.billingAddress.city
                                    postalCode: $order.billingAddress.postalCode
                                    country: $order.billingAddress.country
                                    region: $order.billingAddress.region
                                    regionText: $order.billingAddress.regionText
                                    namePrefix: $order.billingAddress.namePrefix
                                    firstName: $order.billingAddress.firstName
                                    middleName: $order.billingAddress.middleName
                                    lastName: $order.billingAddress.lastName
                                    nameSuffix: $order.billingAddress.nameSuffix
                                    phone: $order.billingAddress.phone
                            - '@call_method':
                                object: $.result.customerBillingAddress
                                method: addType
                                method_parameters:
                                    - $.result.typeBilling
                            - '@flush_entity':
                                conditions:
                                    '@not_empty': $.result.customerBillingAddress
                                parameters: [$.result.customerBillingAddress]

                    # Save shipping address if required
                    - '@assign_constant_value': [$.result.typeShippingName, Oro\Bundle\AddressBundle\Entity\AddressType::TYPE_SHIPPING]
                    - '@tree':
                        conditions:
                            '@and':
                                - '@equal': [$checkout.saveShippingAddress, true]
                                - '@empty': $order.shippingAddress.customerAddress
                                - '@empty': $order.shippingAddress.customerUserAddress
                                - '@acl_granted': 'oro_order_address_shipping_allow_manual'
                        actions:
                            - '@find_entity':
                                class: Oro\Bundle\AddressBundle\Entity\AddressType
                                attribute: $.result.typeShipping
                                identifier: $.result.typeShippingName
                            - '@tree':
                                conditions:
                                    '@equal': [$checkout.shipToBillingAddress, false]
                                actions:
                                    - '@create_entity':
                                        attribute: $.result.customerShippingAddress
                                        class: Oro\Bundle\CustomerBundle\Entity\CustomerUserAddress
                                        data:
                                            frontendOwner: $checkout.customerUser
                                            owner: $checkout.owner
                                            systemOrganization: $checkout.organization
                                            label: $checkout.shippingAddress.label
                                            organization: $checkout.shippingAddress.organization
                                            street: $order.shippingAddress.street
                                            street2: $order.shippingAddress.street2
                                            city: $order.shippingAddress.city
                                            postalCode: $order.shippingAddress.postalCode
                                            country: $order.shippingAddress.country
                                            region: $order.shippingAddress.region
                                            regionText: $order.shippingAddress.regionText
                                            namePrefix: $order.shippingAddress.namePrefix
                                            firstName: $order.shippingAddress.firstName
                                            middleName: $order.shippingAddress.middleName
                                            lastName: $order.shippingAddress.lastName
                                            nameSuffix: $order.shippingAddress.nameSuffix
                                            phone: $order.shippingAddress.phone
                                    - '@call_method':
                                        object: $.result.customerShippingAddress
                                        method: addType
                                        method_parameters:
                                            - $.result.typeShipping
                            - '@call_method':
                                conditions:
                                    '@equal': [$checkout.shipToBillingAddress, true]
                                parameters:
                                    object: $.result.customerBillingAddress
                                    method: addType
                                    method_parameters:
                                        - $.result.typeShipping
                            - '@flush_entity':
                                conditions:
                                    '@not_empty': $.result.customerShippingAddress
                                parameters: [$.result.customerShippingAddress]

                    - '@tree':
                        conditions:
                            '@not_empty': $order.id
                        actions:
                            - '@assign_url':
                                attribute: $.result.successUrl
                                route: oro_checkout_frontend_checkout
                                route_parameters:
                                    id: $checkout.id
                            - '@payment_purchase':
                                attribute: $.result.responseData
                                object:  $order
                                amount:  $order.total
                                currency:  $order.currency
                                paymentMethod: $payment_method
                                transactionOptions:
                                    successUrl: $.result.successUrl
                            - '@redirect':
                                route: oro_checkout_frontend_checkout
                                route_parameters:
                                    id: $checkout.id
                    - '@extendable':
                        events: [extendable_action.finish_checkout]

                    - '@assign_value': [$checkout.completed, true]

                    - '@tree':
                        conditions:
                            '@not_empty': $order
                        actions:
                            - '@count':
                                value: $order.lineItems
                                attribute: $checkout.completedData.itemsCount
                            - '@assign_value': [$.result.orders, []]
                            - '@get_class_name':
                                object: $order
                                attribute: $.result.orderClassName
                            - '@call_service_method':
                                service: oro_entity.entity_alias_resolver
                                method: getAlias
                                method_parameters: [$.result.orderClassName]
                                attribute: $.result.orders[0].entityAlias
                            - '@call_service_method':
                                service: oro_entity.doctrine_helper
                                method: getEntityIdentifier
                                method_parameters: [$order]
                                attribute: $.result.orders[0].entityId
                            - '@assign_value': [$checkout.completedData.orders, $.result.orders]
                    - '@assign_value': [$.result.sourceEntity, $checkout.sourceEntity]
                    - '@tree':
                        conditions:
                            '@not_empty': $.result.sourceEntity
                        actions:
                            - '@assign_value':
                                conditions:
                                    '@instanceof': [$.result.sourceEntity, Oro\Bundle\SaleBundle\Entity\QuoteDemand]
                                parameters:
                                    attribute: $.result.sourceEntity
                                    value: $.result.sourceEntity.quote
                            - '@call_service_method':
                                service: oro_entity.entity_name_resolver
                                method: getName
                                method_parameters: [$.result.sourceEntity]
                                attribute: $checkout.completedData.startedFrom
                            - '@assign_value':
                                - [$checkout.completedData.currency, $order.currency]
                                - [$checkout.completedData.subtotal, $order.subtotalObject.value]
                                - [$checkout.completedData.total, $order.totalObject.value]

                    - '@remove_entity':
                        conditions:
                            '@or':
                                - '@equal': [$auto_remove_source, true]
                                - '@and':
                                    - '@equal': [$allow_manual_source_remove, true]
                                    - '@equal': [$remove_source, true]
                        parameters: [$checkout.sourceEntity]

            continue_to_request_approval_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                preconditions:
                    '@and':
                        - '@not':
                            - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                        - '@not':
                            - '@less_order_total_limit': [$checkout, $.data.order_approval_threshold]
                        - '@equal': [$allowed, false]
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                conditions:
                    '@or':
                        - '@empty': $.result.savedCheckoutState
                        - '@check_checkout_states':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                state1: $.result.initCheckoutState
                                state2: $.result.savedCheckoutState
                actions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            request_for_approve_order_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                conditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@or':
                            - '@empty': $.result.savedCheckoutState
                            - '@check_checkout_states':
                                message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                                parameters:
                                    entity: $checkout
                                    state1: $.result.initCheckoutState
                                    state2: $.result.savedCheckoutState
                actions:
                    - '@assign_value':
                        conditions:
                            '@equal': [$requested_for_approve, false]
                        parameters: [$requested_for_approve, true]
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            approve_order_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                preconditions:
                    '@and':
                        - '@acl_granted': 'oro_alternativecheckout_checkout_approve'
                        - '@equal': [$allowed, false]
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                conditions:
                    '@or':
                        - '@empty': $.result.savedCheckoutState
                        - '@check_checkout_states':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                state1: $.result.initCheckoutState
                                state2: $.result.savedCheckoutState
                actions:
                    - '@assign_value':
                        conditions:
                            '@equal': [$allowed, false]
                        parameters: [$allowed, true]
                    - '@create_datetime':
                        attribute: $allow_request_date
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]

            continue_to_order_review_definition:
                preactions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.currentCheckoutState
                    - '@get_checkout_state':
                        entity: $checkout
                        token: $state_token
                        attribute: $.result.tokenCheckoutState
                    - '@run_action_group':
                        action_group: oro_update_shipping_price
                        parameters_mapping:
                            checkout: $checkout
                    - '@tree':
                        conditions:
                            '@not':
                                - '@check_checkout_states':
                                    entity: $checkout
                                    state1: $.result.currentCheckoutState
                                    state2: $.result.tokenCheckoutState
                        actions:
                            - '@assign_value': [$.result.savedCheckoutState, $.result.tokenCheckoutState]
                            - '@delete_checkout_state':
                                entity: $checkout
                                token: $state_token
                            - '@save_checkout_state':
                                entity: $checkout
                                state: $.result.currentCheckoutState
                                token: $state_token
                    - '@call_service_method':
                        service: oro_checkout.factory.payment_context_factory
                        method: create
                        method_parameters: [$checkout]
                        attribute: $.result.paymentContext
                preconditions:
                    '@and':
                        - '@quote_acceptable': [$checkout.sourceEntity, true]
                        - '@payment_method_applicable':
                            payment_method: 'payment_term'
                            context: $.result.paymentContext
                        - '@order_line_item_has_count':
                            message: oro.checkout.workflow.condition.order_line_item_has_count.message
                            parameters:
                                entity: $checkout
                conditions:
                    '@or':
                        - '@empty': $.result.savedCheckoutState
                        - '@check_checkout_states':
                            message: oro.checkout.workflow.condition.content_of_order_was_changed.message
                            parameters:
                                entity: $checkout
                                state1: $.result.initCheckoutState
                                state2: $.result.savedCheckoutState
                actions:
                    - '@generate_checkout_state_snapshot':
                        entity: $checkout
                        attribute: $.result.actualCheckoutState
                    - '@save_checkout_state':
                        entity: $checkout
                        state: $.result.actualCheckoutState
                        attribute: $state_token
                    - '@assign_value': [$internal_state_token, $state_token]
