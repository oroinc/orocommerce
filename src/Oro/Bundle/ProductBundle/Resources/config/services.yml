parameters:
    oro_product.entity.product.class: Oro\Bundle\ProductBundle\Entity\Product
    oro_product.entity.brand.class: Oro\Bundle\ProductBundle\Entity\Brand
    oro_product.entity.product_unit.class: Oro\Bundle\ProductBundle\Entity\ProductUnit
    oro_product.entity.product_unit_precision.class: Oro\Bundle\ProductBundle\Entity\ProductUnitPrecision
    oro_product.entity.product_variant_link.class: Oro\Bundle\ProductBundle\Entity\ProductVariantLink
    oro_product.entity.product_image.class: Oro\Bundle\ProductBundle\Entity\ProductImage
    oro_product.entity.product_image_type.class: Oro\Bundle\ProductBundle\Entity\ProductImageType
    oro_product.event_listener.scoped_product_db_query_restriction.common_class: Oro\Bundle\ProductBundle\EventListener\ScopedProductDBQueryRestrictionEventListener
    oro_product.event_listener.scoped_product_search_query_restriction.common_class: Oro\Bundle\ProductBundle\EventListener\ScopedProductSearchQueryRestrictionEventListener

services:
    oro_product.product.manager.api:
        class: 'Oro\Bundle\SoapBundle\Entity\Manager\ApiEntityManager'
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - '%oro_product.entity.product.class%'
            - "@doctrine.orm.entity_manager"

    oro_product.brand.manager.api:
        class: 'Oro\Bundle\SoapBundle\Entity\Manager\ApiEntityManager'
        parent: oro_soap.manager.entity_manager.abstract
        arguments:
            - '%oro_product.entity.brand.class%'
            - "@doctrine.orm.entity_manager"

    oro_product.service.quantity_rounding:
        class: 'Oro\Bundle\ProductBundle\Rounding\QuantityRoundingService'
        public: false
        parent: oro_currency.service.abstract_rounding

    oro_product.formatter.unit_value:
        abstract: true
        class: 'Oro\Bundle\ProductBundle\Formatter\UnitValueFormatter'
        arguments:
            - "@translator"

    oro_product.formatter.unit_label:
        abstract: true
        class: 'Oro\Bundle\ProductBundle\Formatter\UnitLabelFormatter'
        arguments:
            - "@translator"

    oro_product.formatter.product_unit_value:
        parent: oro_product.formatter.unit_value
        public: true
        calls:
            - [setTranslationPrefix, ['oro.product_unit']]

    oro_product.formatter.product_unit_label:
        parent: oro_product.formatter.unit_label
        public: true
        calls:
            - [setTranslationPrefix, ['oro.product_unit']]

    oro_product.twig.product_unit_value:
        class: 'Oro\Bundle\ProductBundle\Twig\ProductUnitValueExtension'
        public: false
        arguments:
            - "@service_container"
        tags:
            - { name: twig.extension }

    oro_product.twig.product_form_unit_fields_settings:
        class: 'Oro\Bundle\ProductBundle\Twig\ProductUnitFieldsSettingsExtension'
        public: false
        arguments:
            - "@service_container"
        tags:
            - { name: twig.extension }

    oro_product.twig.unit_visibility:
        class: 'Oro\Bundle\ProductBundle\Twig\UnitVisibilityExtension'
        public: false
        arguments:
            - "@service_container"
        tags:
            - { name: twig.extension }

    oro_product.twig.product_unit_label:
        class: 'Oro\Bundle\ProductBundle\Twig\ProductUnitLabelExtension'
        public: false
        arguments:
            - '@oro_product.formatter.product_unit_label'
        tags:
            - { name: twig.extension }

    oro_product.twig.product_extension:
        class: Oro\Bundle\ProductBundle\Twig\ProductExtension
        public: false
        arguments:
            - "@service_container"
        tags:
            - { name: twig.extension }

    oro_product.form.autocomplete.product.search_handler:
        public: false
        parent: oro_form.autocomplete.search_handler
        arguments:
            - '%oro_product.entity.product.class%'
            - ["sku", "defaultName.string"]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: Oro\Bundle\ProductBundle\Form\Type\ProductType, acl_resource: oro_product_view }
            - { name: oro_form.autocomplete.search_handler, alias: oro_product_frontend, acl_resource: oro_product_frontend_view }

    oro_product.form.autocomplete.brand.search_handler:
        public: false
        parent: oro_form.autocomplete.search_handler
        arguments:
            - '%oro_product.entity.brand.class%'
            - ["name"]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: Oro\Bundle\ProductBundle\Form\Type\BrandType }

    oro_product.service.sku_incrementor:
        class: 'Oro\Bundle\ProductBundle\Duplicator\SkuIncrementor'
        public: false
        arguments:
            - "@oro_entity.doctrine_helper"
            - '%oro_product.entity.product.class%'

    oro_product.service.duplicator:
        class: 'Oro\Bundle\ProductBundle\Duplicator\ProductDuplicator'
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@event_dispatcher"
            - "@oro_attachment.file_manager"
            - "@oro_attachment.provider.attachment"
        calls:
            - [setSkuIncrementor,  ["@oro_product.service.sku_incrementor"]]

    oro_product.service.related_items_handler:
        class: 'Oro\Bundle\ProductBundle\Form\Handler\RelatedItemsHandler'
        arguments:
            - '@translator'
        calls:
            - [addAssigner, ['relatedProducts', '@oro_product.related_item.related_product.assigner_strategy']]
            - [addAssigner, ['upsellProducts', '@oro_product.related_item.upsell_product.assigner_strategy']]

    oro_product.service.product_update_handler:
        class: 'Oro\Bundle\ProductBundle\Form\Handler\ProductUpdateHandler'
        parent: oro_form.model.update_handler
        calls:
            - [setActionGroupRegistry, ['@oro_action.action_group_registry']]
            - [setTranslator, ['@translator']]
            - [setRouter, ['@router']]
            - [setRelatedItemsHandler, ['@oro_product.service.related_items_handler']]

    oro_product.storage.product_data_bag:
        class: Symfony\Component\HttpFoundation\Session\Attribute\AttributeBag
        public: false
        arguments:
            - '_product_data_bag'
        calls:
            - [setName, ['product_data_bag']]

    oro_product.storage.session_data_storage:
        class: 'Oro\Bundle\ProductBundle\Storage\ProductDataStorage'
        abstract: true
        arguments:
            - "@session"

    oro_product.storage.product_data_storage:
        class: 'Oro\Bundle\ProductBundle\Storage\ProductDataStorage'
        parent: oro_product.storage.session_data_storage

    oro_product.validator.product_by_sku:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductBySkuValidator'
        arguments:
            - "@doctrine"
        tags:
            - { name: validator.constraint_validator, alias: oro_product_product_by_sku_validator }

    oro_product.validator.quick_add_row_collection:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\QuickAddRowCollectionValidator'
        arguments:
            - "@validator"
        tags:
            - { name: validator.constraint_validator, alias: oro_product_quick_add_row_collection_validator }

    oro_product.validator.quantity_unit_precision:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\QuantityUnitPrecisionValidator'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_quantity_unit_precision }

    oro_product.validator.product_unit_exists:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductUnitExistsValidator'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_product_unit_exists }

    oro_product.validator.product_image:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductImageValidator'
        public: true
        tags:
            - { name: validator.constraint_validator, alias: oro_product_image_validator }

    oro_product.validator.product_image_type:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductImageTypeValidator'
        arguments:
            - "@oro_layout.provider.image_type"
            - "@translator"
        tags:
            - { name: validator.constraint_validator, alias: oro_product_image_type_validator }

    oro_product.validator.product_image_collection:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductImageCollectionValidator'
        public: true
        arguments:
            - "@oro_layout.provider.image_type"
            - "@translator"
            - "@oro_product.helper.product_image_helper"
        tags:
            - { name: validator.constraint_validator, alias: oro_product_image_collection_validator }

    oro_product.validator.not_empty_configurable_attributes:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\NotEmptyConfigurableAttributesValidator'
        public: true
        arguments:
            - '@oro_product.provider.variant_field_provider'
        tags:
            - { name: validator.constraint_validator, alias: not_empty_configurable_attributes }

    oro_product.validator.product_page_template:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductPageTemplateValidator'
        arguments:
            - '@oro_layout.page_templates_manager'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_page_template_validator }

    oro_product.component_processor.filter:
        class: 'Oro\Bundle\ProductBundle\ComponentProcessor\ComponentProcessorFilter'
        public: false
        arguments:
            - "@oro_product.website_search.repository.product"

    oro_product.website_search.repository.product:
        parent: oro_website_search.repository.abstract
        class: 'Oro\Bundle\ProductBundle\Search\ProductRepository'
        calls:
            - [setEntityName, ['%oro_product.entity.product.class%']]

    oro_product.component_processor.registry:
        class: 'Oro\Bundle\ProductBundle\ComponentProcessor\ComponentProcessorRegistry'
        public: false

    oro_product.component_processor.data_storage_aware.processor:
        class: 'Oro\Bundle\ProductBundle\ComponentProcessor\DataStorageAwareComponentProcessor'
        arguments:
            - "@router"
            - "@oro_product.storage.product_data_storage"
            - "@security.authorization_checker"
            - "@oro_security.token_accessor"
            - "@session"
            - "@translator"
        calls:
            - [setComponentProcessorFilter,  ["@oro_product.component_processor.filter"]]
        abstract: true

    oro_product.form_handler.quick_add:
        class: 'Oro\Bundle\ProductBundle\Form\Handler\QuickAddHandler'
        arguments:
            - "@oro_product.layout.data_provider.product_form"
            - "@oro_product.model.builder.quick_add_row_collection"
            - "@oro_product.component_processor.registry"
            - "@router"
            - "@translator"
            - "@validator"
            - "@oro_product.helper.product_grouper.factory"
            - "@event_dispatcher"

    oro_product.event_listener.related_items_product_edit_listener:
        class: Oro\Bundle\ProductBundle\EventListener\RelatedItemsProductEditListener
        arguments:
            - '@translator'
            - '@oro_product.related_item.helper.config_helper'
            - '@security.authorization_checker'
        tags:
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-edit, method: onProductEdit }
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-related-items-update, method: onProductEdit }
            - { name: kernel.event_listener, event: oro.form.update_handler.before_form_data_set.oro_product, method: onFormDataSet }

    oro_product.event_listener.product_grid_widget:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductGridWidgetRenderEventListener'
        arguments:
            - "@oro_datagrid.datagrid.request_parameters_factory"
        tags:
            - { name: kernel.event_listener, event: product_grid.render, method: onWidgetRender }

    oro_product.menu.frontend.quick_add:
        class: 'Oro\Bundle\ProductBundle\Menu\Frontend\QuickAddMenuBuilder'
        public: false
        arguments:
            - "@oro_product.component_processor.registry"
        tags:
            - { name: oro_menu.builder, alias: frontend_menu }

    oro_product.provider.custom_field_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\CustomFieldProvider'
        public: false
        arguments:
            - "@oro_entity_config.provider.extend"
            - "@oro_entity_config.provider.entity"

    oro_product.provider.product_status_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductStatusProvider'

    oro_product.provider.product_inventory_status_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductInventoryStatusProvider'
        arguments:
            - '@doctrine'

    oro_product.provider.product_type_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductTypeProvider'

    oro_product.product_unit.cache:
        public: false
        parent: oro.cache.abstract
        calls:
            - [ setNamespace, ['oro_product_unit'] ]

    oro_product.provider.product_units_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductUnitsProvider'
        arguments:
            - '@doctrine'
            - '@oro_product.formatter.product_unit_label'
            - '@oro_product.product_unit.cache'

    oro_product.service.single_unit_mode:
        class: 'Oro\Bundle\ProductBundle\Service\SingleUnitModeService'
        public: false
        arguments:
            - "@oro_config.manager"

    oro_product.layout.data_provider.single_unit_mode:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\SingleUnitModeProvider'
        arguments:
            - "@oro_product.service.single_unit_mode"
        tags:
            - { name: layout.data_provider, alias: oro_product_single_unit_mode }

    oro_product.layout.data_provider.unit_visibility:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\UnitVisibilityProvider'
        arguments:
            - "@oro_product.visibility.unit"
        tags:
            - { name: layout.data_provider, alias: oro_unit_visibility }

    oro_product.layout.data_provider.product_unit_fields_settings:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ProductUnitFieldsSettingsProvider'
        arguments:
            - "@oro_product.visibility.product_unit_fields_settings"
        tags:
            - { name: layout.data_provider, alias: oro_product_unit_fields_settings }

    oro_product.provider.default_product_unit_provider.chain:
        class: 'Oro\Bundle\ProductBundle\Provider\ChainDefaultProductUnitProvider'
        public: false

    oro_product.provider.default_product_unit_provider.system:
        class: 'Oro\Bundle\ProductBundle\Provider\SystemDefaultProductUnitProvider'
        public: false
        arguments:
            - "@oro_config.manager"
            - "@oro_entity.doctrine_helper"
        tags:
            - {name: oro_product.default_product_unit_provider, priority: 0}

    oro_product.provider.default_product_unit_provider.single_unit:
        class: 'Oro\Bundle\ProductBundle\Provider\SingleUnitDefaultProductUnitProvider'
        public: false
        arguments:
            - "@oro_product.service.single_unit_mode"
            - "@oro_product.provider.default_product_unit_provider.system"
        tags:
            - {name: oro_product.default_product_unit_provider, priority: 240}

    oro_product.event_listener.product_variant_custom_fields_datagrid:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductVariantCustomFieldsDatagridListener'
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_product.provider.custom_field_provider"
            - "@oro_product.provider.variant_field_provider"
            - '%oro_product.entity.product.class%'
            - '%oro_product.entity.product_variant_link.class%'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.product-product-variants-view, method: onBuildAfter }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.product-product-variants-edit, method: onBuildAfterEditGrid }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.product-product-variants-edit, method: onBuildBeforeHideUnsuitable }

    oro_product.validator.unique_variant_links:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\UniqueProductVariantLinksValidator'
        arguments:
            - '@property_accessor'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_unique_variant_links }

    oro_product.validator.variant_links:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductVariantLinksValidator'
        arguments:
            - '@property_accessor'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_variant_links }

    oro_product.validator.unique_variant_links_simple_product:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\UniqueVariantLinksSimpleProductValidator'
        arguments:
            - '@validator'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_unique_variant_links_simple_product }

    oro_product.validator.empty_variant_field_in_simple_product_for_variant_links:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\EmptyVariantFieldInSimpleProductForVariantLinksValidator'
        arguments:
            - '@property_accessor'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_empty_variant_field_in_simple_product_for_variant_links }

    oro_product.validator.product_variant_field:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductVariantFieldValidator'
        arguments:
            - '@oro_product.provider.custom_field_provider'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_variant_field }

    oro_product.validator.attribute_family_usages_product_variant_field:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\AttributeFamilyUsageInVariantFieldValidator'
        arguments:
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_entity.doctrine_helper'
        tags:
            - { name: validator.constraint_validator, alias: oro_product_attribute_family_usage_in_variant_field }

    oro_product.event_listener.restricted_products_datagrid:
        class: 'Oro\Bundle\ProductBundle\EventListener\RestrictedProductsDatagridEventListener'
        arguments:
            - "@request_stack"
            - "@oro_product.product.manager"
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.products-select-grid, method: onBuildAfter }

    oro_product.event_listener.command.platform_update:
        class: 'Oro\Bundle\ProductBundle\EventListener\PlatformUpdateCommandListener'
        arguments:
            - "@oro_entity_config.config_model_manager"
        tags:
            - { name: kernel.event_listener, event: console.command, method: onConsoleCommand }

    oro_product.entity.event_listener.product_collection_variant_reindex_message_send_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductCollectionVariantReindexMessageSendListener'
        arguments:
            - '@oro_message_queue.client.message_producer'
            - '@oro_product.helper.product_collection_segment'
            - '@oro_product.model.segment_message_factory'
        tags:
            - { name: doctrine.event_listener, event: postFlush }

    oro_product.event_listener.product_content_variant_reindex:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductContentVariantReindexEventListener'
        arguments:
            - "@event_dispatcher"
            - '@oro_entity.doctrine.field_updates_checker'
            - '@oro_product.entity.event_listener.product_collection_variant_reindex_message_send_listener'
            - "@?oro_web_catalog.provider.web_catalog_usage_provider"
        tags:
            - { name: doctrine.event_listener, event: onFlush, connection: default }

    oro_product.model.product_visibility_query_builder_modifier:
        class: 'Oro\Bundle\ProductBundle\Model\ProductVisibilityQueryBuilderModifier'
        public: false

    oro_product.model.product_visibility_search_query_modifier:
        class: 'Oro\Bundle\ProductBundle\Model\ProductVisibilitySearchQueryModifier'
        public: false

    oro_product.autocomplete.product_visibility_limited.search_handler:
        class: 'Oro\Bundle\ProductBundle\Autocomplete\ProductVisibilityLimitedSearchHandler'
        public: false
        arguments:
            - '%oro_product.entity.product.class%'
            - "@request_stack"
            - "@oro_product.product.manager"
            - "@oro_locale.helper.localization"
        calls:
            - [initDoctrinePropertiesByManagerRegistry, ["@doctrine"]]
            - [setAclHelper,["@oro_security.acl_helper"]]
            - [setFrontendHelper,["@oro_frontend.request.frontend_helper"]]
            - [setSearchRepository,["@oro_product.website_search.repository.product"]]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: "oro_product_visibility_limited" }

    oro_product.autocomplete.configurable_product_visibility_limited.search_handler:
        parent: oro_product.autocomplete.product_visibility_limited.search_handler
        calls:
            - [enableConfigurableProducts]
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: "oro_all_product_visibility_limited" }

    oro_product.autocomplete.oro_product_visibility_limited_with_prices.search_handler:
        class: 'Oro\Bundle\ProductBundle\Autocomplete\ProductVisibilityLimitedWithPricesSearchHandler'
        public: false
        arguments:
            - '@oro_pricing.form.autocomplete.product_with_prices.search_handler'
            - '@oro_product.autocomplete.product_visibility_limited.search_handler'
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: "oro_product_visibility_limited_with_prices" }

    oro_product.product.manager:
        class: 'Oro\Bundle\ProductBundle\Entity\Manager\ProductManager'
        arguments:
            - "@event_dispatcher"

    oro_product.event_listener.restrict_disabled_products:
        class: 'Oro\Bundle\ProductBundle\EventListener\RestrictDisabledProductsEventListener'
        arguments:
            - "@oro_product.model.product_visibility_search_query_modifier"
            - "@oro_product.model.product_visibility_query_builder_modifier"
        tags:
            - { name: kernel.event_listener, event: oro_product.product_search_query.restriction, method: onSearchQuery }
            - { name: kernel.event_listener, event: oro_product.product_db_query.restriction, method: onDBQuery }

    oro_product.event_listener.abstract_product_db_query_restriction:
        abstract: true
        arguments:
            - "@oro_config.manager"
            - "@oro_product.model.product_visibility_query_builder_modifier"
            - "@oro_frontend.request.frontend_helper"

    oro_product.event_listener.product_db_query_restriction:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductDBQueryRestrictionEventListener'
        parent: oro_product.event_listener.abstract_product_db_query_restriction
        calls:
            - [setFrontendSystemConfigurationPath, ['oro_product.general_frontend_product_visibility']]
        tags:
            - { name: kernel.event_listener, event: oro_product.product_db_query.restriction, method: onDBQuery }

    oro_product.event_listener.abstract_product_search_query_restriction:
        abstract: true
        arguments:
            - "@oro_config.manager"
            - "@oro_product.model.product_visibility_search_query_modifier"
            - "@oro_frontend.request.frontend_helper"
            - "oro_product.general_frontend_product_visibility"

    oro_product.event_listener.product_search_query_restriction:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductSearchQueryRestrictionEventListener'
        parent: oro_product.event_listener.abstract_product_search_query_restriction
        tags:
            - { name: kernel.event_listener, event: oro_product.product_search_query.restriction, method: onSearchQuery }

    oro_product.repository.product:
        class: 'Oro\Bundle\ProductBundle\Entity\Repository\ProductRepository'
        parent: oro_entity.abstract_repository
        arguments:
            - '%oro_product.entity.product.class%'

    oro_product.repository.product_unit:
        class: 'Oro\Bundle\ProductBundle\Entity\Repository\ProductUnitRepository'
        parent: oro_entity.abstract_repository
        arguments:
            - '%oro_product.entity.product_unit.class%'

    oro_product.restricted_repository.product:
        class: Oro\Bundle\ProductBundle\Entity\Repository\Restriction\RestrictedProductRepository
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@oro_product.product.manager'
            - '%oro_product.entity.product.class%'

    oro_product.repository.product_image:
        parent: oro_entity.abstract_repository
        arguments:
            - '%oro_product.entity.product_image.class%'

    oro_product.model.builder.quick_add_row_input_parser:
        class: 'Oro\Bundle\ProductBundle\Model\Builder\QuickAddRowInputParser'
        arguments:
            - '@doctrine'
            - '@oro_product.provider.product_units_provider'

    oro_product.model.builder.quick_add_row_collection:
        class: 'Oro\Bundle\ProductBundle\Model\Builder\QuickAddRowCollectionBuilder'
        public: false
        arguments:
            - "@oro_product.repository.product"
            - "@oro_product.product.manager"
            - "@event_dispatcher"
            - "@oro_product.model.builder.quick_add_row_input_parser"

    oro_product.datagrid_theme_helper:
        class: 'Oro\Bundle\ProductBundle\DataGrid\DataGridThemeHelper'
        public: false
        arguments:
            - '@request_stack'
            - '@session'

    oro_product.event_listener.frontend_product_search_datagrid:
        class: 'Oro\Bundle\ProductBundle\EventListener\FrontendProductDatagridListener'
        arguments:
            - '@oro_product.datagrid_theme_helper'
            - '@liip_imagine.cache.manager'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.frontend-product-search-grid, method: onPreBuild }
            - { name: kernel.event_listener, event: oro_datagrid.search_datasource.result.after.frontend-product-search-grid, method: onResultAfter }

    oro_product.event_listener.doctrine.product_variants_changed:
        class: Oro\Bundle\ProductBundle\EventListener\Doctrine\ProductVariantsChangedListener
        arguments:
            - '@oro_product.search.product_reindex_manager'
        tags:
            - { name: doctrine.orm.entity_listener, entity_manager: default, entity: '%oro_product.entity.product_variant_link.class%', event: prePersist}
            - { name: doctrine.orm.entity_listener, entity_manager: default, entity: '%oro_product.entity.product_variant_link.class%', event: preRemove}

    oro_product.event_listener.doctrine.product_unit:
        class: Oro\Bundle\ProductBundle\EventListener\Doctrine\ProductUnitEntityListener
        public: false
        arguments:
            - '@oro_product.provider.product_units_provider'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product_unit.class%', event: postPersist, method: invalidateProductUnitCache }
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product_unit.class%', event: postUpdate, method: invalidateProductUnitCache }
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product_unit.class%', event: postRemove, method: invalidateProductUnitCache }

    oro_product.event_listener.product_handler:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductHandlerListener'
        arguments:
            - '@property_accessor'
            - '@logger'
        tags:
            - { name: kernel.event_listener, event: oro.form.update_handler.before_entity_flush, method: onBeforeFlush }

    oro_product.layout.data_provider.product_form:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ProductFormProvider'
        arguments:
            - '@form.factory'
            - '@router'
            - '@oro_product.provider.product_variant_availability_provider'
        tags:
            - { name: layout.data_provider, alias: oro_product_form }

    oro_product.provider.product_matrix_availability_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductMatrixAvailabilityProvider'
        arguments:
            - '@oro_product.provider.product_variant_availability_provider'

    oro_product.layout.data_provider.product_form_availability_provider:
        abstract: true
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ProductFormAvailabilityProvider'
        arguments:
            - '@oro_config.manager'
            - '@oro_product.provider.product_matrix_availability_provider'
            - '@oro_ui.user_agent_provider'

    oro_product.layout.data_provider.product_view_form_availability_provider:
        parent: oro_product.layout.data_provider.product_form_availability_provider
        calls:
            - [setMatrixFormConfig, ['matrix_form_on_product_view']]
        tags:
            - { name: layout.data_provider, alias: product_view_form_availability_provider }

    oro_product.layout.data_provider.product_list_form_availability_provider:
        parent: oro_product.layout.data_provider.product_form_availability_provider
        calls:
            - [setMatrixFormConfig, ['matrix_form_on_product_listing']]
        tags:
            - { name: layout.data_provider, alias: product_list_form_availability_provider }

    oro_product.layout.data_provider.product_variant:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ProductVariantProvider'
        arguments:
            - '@oro_product.provider.product_variant_availability_provider'
        tags:
            - { name: layout.data_provider, alias: oro_product_variant }

    oro_product.event_listener.website_search_segment:
        class: 'Oro\Bundle\ProductBundle\EventListener\WebsiteSearchSegmentListener'
        arguments:
            - '@oro_product.provider.content_variant_segment_provider'
            - '@oro_segment.static_segment_manager'
        tags:
            # this listener is intentionally listens to common event instead of product specific event
            # to make sure that this listener will be executed before the
            # Oro\Bundle\WebCatalogBundle\EventListener\WebCatalogEntityIndexerListener
            - { name: kernel.event_listener, event: oro_website_search.event.index_entity, method: onWebsiteSearchIndex, priority: 255 }

    oro_product.provider.website_search_index_data:
        class: 'Oro\Bundle\ProductBundle\Search\WebsiteSearchProductIndexDataProvider'
        arguments:
            - '@oro_entity_config.registry.attribute_type'
            - '@oro_entity_config.provider.attribute_configuration'
            - '@oro_product.provider.index_fields'
            - '@property_accessor'

    oro_product.provider.website_search_index_data.product_variants:
        class: 'Oro\Bundle\ProductBundle\Search\ProductVariantIndexDataProviderDecorator'
        decorates: 'oro_product.provider.website_search_index_data'
        decoration_inner_name: 'oro_product.provider.website_search_index_data.original'
        arguments:
            - '@oro_product.provider.website_search_index_data.original'

    oro_product.event_listener.website_search_index:
        class: 'Oro\Bundle\ProductBundle\EventListener\WebsiteSearchProductIndexerListener'
        arguments:
            - '@oro_website.provider.website_localization'
            - '@oro_website_search.manager.website_context_manager'
            - '@doctrine'
            - '@oro_attachment.manager'
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_product.provider.website_search_index_data'
        tags:
            - { name: kernel.event_listener, event: oro_website_search.event.index_entity.product, method: onWebsiteSearchIndex, priority: -255 }

    oro_product.event_listener.restrict_index_products:
        class: 'Oro\Bundle\ProductBundle\EventListener\RestrictIndexProductsEventListener'
        arguments:
            - '@oro_config.manager'
            - '@oro_product.model.product_visibility_query_builder_modifier'
            - 'oro_product.general_frontend_product_visibility'
        tags:
            - { name: kernel.event_listener, event: oro_website_search.event.restrict_index_entity.product, method: onRestrictIndexEntityEvent }

    oro_product.event_listener.restrict_product_variant_event:
        class: 'Oro\Bundle\ProductBundle\EventListener\RestrictProductVariantEventListener'
        arguments:
            - '@oro_config.manager'
            - '@oro_product.model.product_visibility_query_builder_modifier'
            - 'oro_product.general_frontend_product_visibility'
        tags:
            - { name: kernel.event_listener, event: oro_product.event.restrict_product_variant_event, method: onRestrictProductVariantEvent }

    oro_product.layout.data_provider.cache:
        parent: oro.cache.abstract
        public: false
        calls:
            - [ setNamespace, [ 'oro_product' ] ]

    oro_product.layout.data_provider.cache_cleaner:
        class: 'Oro\Component\Cache\Layout\DataProviderCacheCleaner'
        public: false
        arguments:
            - '@oro_product.layout.data_provider.cache'

    oro_product.entity_listener.segment:
        class: 'Oro\Bundle\ProductBundle\Entity\EntityListener\SegmentEntityListener'
        public: false
        arguments:
            - '@oro_product.layout.data_provider.cache_cleaner'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: preUpdate }
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: preRemove }
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: postPersist }

    oro_product.layout.data_provider.abstract_segment_products_provider:
        class: Oro\Bundle\ProductBundle\Layout\DataProvider\AbstractSegmentProductsProvider
        abstract: true
        arguments:
            - '@oro_segment.segment_manager'
            - '@oro_product.provider.segment'
            - '@oro_product.product.manager'
            - '@oro_config.manager'
            - '@doctrine'
            - '@security.token_storage'
            - '@oro_security.encoder.default'
        calls:
            - [setCache, ['@oro_product.layout.data_provider.cache', 3600]]

    oro_product.layout.data_provider.featured_products:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\FeaturedProductsProvider'
        parent: oro_product.layout.data_provider.abstract_segment_products_provider
        tags:
            - { name: layout.data_provider, alias: featured_products }

    oro_product.layout.data_provider.featured_products.cache_decorator:
        parent: oro_product.doctrine.abstract_cached_provider_decorator
        decorates: oro_product.layout.data_provider.featured_products
        decoration_priority: 10
        arguments:
            - '@oro_product.layout.data_provider.featured_products.cache_decorator.inner'
            - '@oro.cache.memory_cache_chain'
            - 'oro_product.layout.data_provider.featured_products'

    oro_product.event_listener.product_image_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductImageListener'
        public: false
        arguments:
            - '@event_dispatcher'
            - '@oro_layout.provider.image_type'
            - '@oro_product.helper.product_image_helper'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product_image.class%', event: postPersist }
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product_image.class%', event: postUpdate }
            - { name: doctrine.orm.entity_listener, entity: '%oro_attachment.file.entity.class%', event: postUpdate, method: filePostUpdate }

    oro_product.migration.demo_data_fixtures_listener.product_image:
        parent: oro_platform.event_listener.demo_data_fixtures_listener.abstract
        calls:
            - [disableListener, ['oro_product.event_listener.product_image_resize_listener']]
        tags:
            - { name: kernel.event_listener, event: oro_migration.data_fixtures.pre_load, method: onPreLoad }
            - { name: kernel.event_listener, event: oro_migration.data_fixtures.post_load, method: onPostLoad }

    oro_product.event_listener.product_image_resize_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductImageResizeListener'
        arguments:
            - '@oro_message_queue.client.message_producer'
        tags:
            - { name: kernel.event_listener, event: oro_product.product_image.resize, method: resizeProductImage }

    oro.product.event_listener.product_images_configuration_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductImagesConfigurationListener'
        arguments:
            - '@session'
            - '@translator'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: afterUpdate }

    oro.product.provider.watermark_image_filter:
        class: 'Oro\Bundle\ProductBundle\Provider\WatermarkImageFilterProvider'
        arguments:
            - '@oro_config.global'
            - '@oro_entity.doctrine_helper'
            - '%oro_attachment.attachments_dir%'
        tags:
            - { name: layout.image_filter.provider }

    oro.product.message_processor.image_resize:
        class: 'Oro\Bundle\ProductBundle\MessageProcessor\ImageResizeMessageProcessor'
        arguments:
            - '@oro_product.repository.product_image'
            - '@oro_layout.loader.image_filter'
            - '@oro_product.provider.product_images_dimensions'
            - '@oro_attachment.image_resizer'
            - '@oro_attachment.media_cache_manager'
            - '@oro_attachment.manager'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_product.product_visibility_restriction_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductVisibilityRestrictionListener'
        arguments:
            - '@oro_product.product.manager'
            - '@oro_website_search.provider.search_mapping'
        tags:
            - { name: kernel.event_listener, event: oro_website_search.before_search, method: process }

    oro_product.exception.product_access_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductAccessExceptionListener'
        arguments:
           - "@request_stack"
        tags:
            - { name: kernel.event_listener, event: kernel.exception, method: onAccessException }

    oro_product.content_variant_type.product_page:
        class: Oro\Bundle\ProductBundle\ContentVariantType\ProductPageContentVariantType
        public: false
        arguments:
            - '@security.authorization_checker'
            - '@property_accessor'
        tags:
            - { name: oro_web_catalog.content_variant_type }

    oro_product.content_variant_type.product_collection:
        class: Oro\Bundle\ProductBundle\ContentVariantType\ProductCollectionContentVariantType
        public: false
        arguments:
            - '@security.authorization_checker'
        tags:
            - { name: oro_web_catalog.content_variant_type }

    oro_product.provider.routing_information_provider:
        class: Oro\Bundle\ProductBundle\Provider\ProductRoutingInformationProvider
        arguments:
            - '@oro_config.global'
        tags:
            - { name: oro_redirect.routing_information_provider, alias: '%oro_product.entity.product.class%' }

    oro_product.provider.brand.routing_information_provider:
        class: Oro\Bundle\ProductBundle\Provider\BrandRoutingInformationProvider
        arguments:
            - '@oro_config.global'
        tags:
            - { name: oro_redirect.routing_information_provider, alias: '%oro_product.entity.brand.class%' }

    oro_product.layout.data_provider.quick_add_collection:
        class: 'Oro\Bundle\ProductBundle\Provider\QuickAddCollectionProvider'
        arguments:
            - '@oro_product.form_handler.quick_add'
            - '@request_stack'
        tags:
            - { name: layout.data_provider, alias: oro_product_quick_add_collection }

    oro_product.provider.product_content_variant_provider:
        class: Oro\Bundle\ProductBundle\Provider\ProductContentVariantProvider
        public: false
        tags:
            - { name: oro_web_catalog.content_variant_provider }

    oro_product.provider.product_collection_content_variant_provider:
        class: Oro\Bundle\ProductBundle\Provider\ProductCollectionContentVariantProvider
        public: false
        tags:
            - { name: oro_web_catalog.content_variant_provider }

    oro_product.event_listener.attribute_family_form_view:
        parent: oro_entity_config.event_listener.attribute_family_form_view.abstract
        tags:
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-create-step-one, method: onEdit }

    oro_product.event_listener.attributes_form_view:
        parent: oro_entity_config.event_listener.attributes_form_view.abstract
        class: Oro\Bundle\ProductBundle\EventListener\AttributeFormViewListener
        tags:
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-edit, method: onEdit, priority: -255 }
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-create-step-two, method: onEdit, priority: -255 }
            - { name: kernel.event_listener, event: oro_ui.scroll_data.before.product-view, method: onViewList, priority: -255 }

    oro_product.provider.product_variant_availability_provider:
        public: false
        class: 'Oro\Bundle\ProductBundle\Provider\ProductVariantAvailabilityProvider'
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@oro_product.provider.custom_field_provider'
            - '@property_accessor'
            - '@event_dispatcher'
            - '@oro_product.product_variant_field.registry.product_variant_field_value_handler_registry'

    oro_product.product_variant.registry.product_variant_type_handler_factory:
        class: 'Oro\Bundle\ProductBundle\ProductVariant\Registry\ProductVariantTypeHandlerRegistry'
        calls:
            - [addHandler,  ['@oro_product.product_variant.type_handler.enum_type_handler']]
            - [addHandler,  ['@oro_product.product_variant.type_handler.boolean_type_handler']]

    oro_product.product_variant_field.registry.product_variant_field_value_handler_registry:
        public: false
        class: 'Oro\Bundle\ProductBundle\ProductVariant\Registry\ProductVariantFieldValueHandlerRegistry'
        calls:
            - [addHandler, ['@oro_product.product_variant_field.field_value_handler.enum_type_handler']]
            - [addHandler, ['@oro_product.product_variant_field.field_value_handler.boolean_type_handler']]

    oro_product.product_variant_field.field_value_handler.enum_type_handler:
        public: false
        class: 'Oro\Bundle\ProductBundle\ProductVariant\VariantFieldValueHandler\EnumVariantFieldValueHandler'
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@oro_entity_extend.enum_value_provider'
            - '@logger'
            - '@oro_entity_config.config_manager'

    oro_product.product_variant_field.field_value_handler.boolean_type_handler:
        public: false
        class: 'Oro\Bundle\ProductBundle\ProductVariant\VariantFieldValueHandler\BooleanVariantFieldValueHandler'
        arguments:
            - '@translator'

    oro_product.product_variant.type_handler.enum_type_handler:
        class: 'Oro\Bundle\ProductBundle\ProductVariant\TypeHandler\EnumTypeHandler'
        arguments:
            - '@form.factory'
            - '%oro_product.entity.product.class%'
            - '@oro_entity_config.config_manager'

    oro_product.product_variant.type_handler.boolean_type_handler:
        class: 'Oro\Bundle\ProductBundle\ProductVariant\TypeHandler\BooleanTypeHandler'
        arguments:
            - '@form.factory'

    oro_product.visibility.product_unit_fields_settings:
        class: 'Oro\Bundle\ProductBundle\Visibility\BasicProductUnitFieldsSettings'
        arguments:
            - "@oro_entity.doctrine_helper"

    oro_product.visibility.single_unit_mode_product_unit_fields_settings_decorator:
        class: 'Oro\Bundle\ProductBundle\Visibility\SingleUnitModeProductUnitFieldsSettingsDecorator'
        public: false
        decorates: oro_product.visibility.product_unit_fields_settings
        decoration_priority: 10
        arguments:
            - "@oro_product.visibility.single_unit_mode_product_unit_fields_settings_decorator.inner"
            - "@oro_product.service.single_unit_mode"
            - "@oro_entity.doctrine_helper"

    oro_product.visibility.unit:
        class: 'Oro\Bundle\ProductBundle\Visibility\BasicUnitVisibility'

    oro_product.visibility.single_unit_mode_unit:
        class: 'Oro\Bundle\ProductBundle\Visibility\SingleUnitModeUnitVisibilityDecorator'
        public: false
        decorates: oro_product.visibility.unit
        decoration_priority: 10
        arguments:
            - "@oro_product.visibility.single_unit_mode_unit.inner"
            - "@oro_product.service.single_unit_mode"

    oro_product.event_listener.unit_visibility.datagrid_basic:
        class: 'Oro\Bundle\ProductBundle\EventListener\UnitVisibilityModeDataGridListener'
        abstract: true
        arguments:
            - 'unitCode'
            - 'quantity'
            - 'OroProductBundle:ProductUnit:Datagrid/quantity.html.twig'
            - {isShortUnitCode: true}
            - '@oro_product.service.single_unit_mode'

    oro_product.provider.privilege_category_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\PrivilegeCategoryProvider'
        tags:
            - { name: oro_user.privilege_category }

    oro_product.layout.data_provider.configurable_products:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ConfigurableProductProvider'
        arguments:
            - '@oro_product.provider.custom_field_provider'
            - '@oro_product.provider.product_variant_availability_provider'
            - '@property_accessor'
            - '@oro_product.product_variant_field.registry.product_variant_field_value_handler_registry'
        tags:
            - { name: layout.data_provider, alias: oro_product_configurable_products }

    oro_product.layout.attribute_block_type_mapper:
        parent: oro_entity_config.block_type.abstract_attribute_block_type_mapper
        calls:
            - [addBlockTypeUsingMetadata, ['%oro_product.entity.product_image.class%', 'attribute_product_images']]
            - [addBlockTypeUsingMetadata, ['%oro_product.entity.brand.class%', 'attribute_product_brand']]
        tags:
            - { name: oro_entity_config.layout.attribute_block_type_mapper }

    oro_product.virtual_fields.decorator_cache:
        parent: doctrine_cache.abstract.array
        public: false
        calls:
        - [ setNamespace, [ 'virtual_fields_decorator_cache' ] ]

    oro_product.virtual_fields.decorator_factory:
        class: 'Oro\Bundle\ProductBundle\VirtualFields\VirtualFieldsProductDecoratorFactory'
        public: false
        arguments:
            - '@oro_product.virtual_fields.select_query_converter'
            - '@doctrine'
            - '@oro_entity.helper.field_helper'
            - '@oro_product.virtual_fields.decorator_cache'

    oro_product.virtual_fields.select_query_converter:
            class: 'Oro\Bundle\ProductBundle\VirtualFields\QueryDesigner\VirtualFieldsSelectQueryConverter'
            arguments:
                - '@oro_query_designer.query_designer.manager'
                - '@oro_entity.virtual_field_provider.chain'
                - '@doctrine'
            calls:
                - [setVirtualRelationProvider, ['@oro_entity.virtual_relation_provider.chain']]

    oro_product.event_listener.before_remove_field_listener:
        class: 'Oro\Bundle\ProductBundle\EventListener\ValidateBeforeRemoveFieldListener'
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@translator'
        tags:
            - { name: kernel.event_listener, event: oro.entity_extend.field.validate.before_remove, method: onValidateBeforeRemoveField }

    oro_product.provider.page_template_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\PageTemplateProvider'
        arguments:
            - '@oro_layout.theme_manager'
            - '@oro_entity.fallback.resolver.entity_fallback_resolver'

    oro_product.config.event_listener.direct_url_prefix_change:
        class: Oro\Bundle\RedirectBundle\EventListener\ConfigRegenerateDirectUrlListener
        arguments:
            - '@oro_config.manager'
            - '@oro_message_queue.client.message_producer'
            - '@oro_redirect.form.storage.redirect_storage'
            - '@oro_redirect.direct_url_message_factory'
            - 'oro_product.product_direct_url_prefix'
            - '%oro_product.entity.product.class%'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: onUpdateAfter }

    oro_product.twig.product_image_extension:
        class: Oro\Bundle\ProductBundle\Twig\ProductImageExtension
        public: false
        tags:
            - { name: twig.extension }

    oro_product.security.acl.voter.product_collection_segment:
        class: Oro\Bundle\ProductBundle\Acl\Voter\ProductCollectionSegmentVoter
        public: false
        arguments:
            - "@oro_entity.doctrine_helper"
            - "@oro_product.provider.content_variant_segment_provider"
        calls:
            - [setClassName, ['%oro_segment.segment.entity.class%']]
        tags:
            - { name: security.voter, priority: 500 }

    oro_product.security.acl.voter.product_status:
        class: Oro\Bundle\ProductBundle\Acl\Voter\ProductStatusVoter
        public: false
        arguments:
            - "@oro_entity.doctrine_helper"
        calls:
            - [setClassName, ['%oro_product.entity.product.class%']]
            - [setFrontendHelper, ["@oro_frontend.request.frontend_helper"]]
        tags:
            - { name: security.voter, priority: 100 }

    oro_product.provider.content_variant_segment_provider:
        class: Oro\Bundle\ProductBundle\Provider\ContentVariantSegmentProvider
        arguments:
            - '@oro_entity.doctrine_helper'

    oro_product.event_listener.product_collection_datagrid:
        class: Oro\Bundle\ProductBundle\EventListener\ProductCollectionDatagridListener
        arguments:
            - '@request_stack'
            - '@oro_segment.segment_manager'
            - '@doctrine'
            - '@oro_datagrid.datagrid.name_strategy'
            - '@oro_product.service.product_collection_definition_converter'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.product-collection-grid, method: onBuildAfter }

    oro_product.provider.segment_with_relations_provider:
        class: Oro\Bundle\ProductBundle\Provider\CronSegmentsProvider
        public: false
        arguments:
            - '@oro_product.provider.content_variant_segment_provider'

    oro_product.model.segment_message_factory:
        class: Oro\Bundle\ProductBundle\Model\SegmentMessageFactory
        public: false
        arguments:
            - '@doctrine'

    oro_product.async.reindex_product_collection_processor:
        class: Oro\Bundle\ProductBundle\Async\ReindexProductCollectionProcessor
        arguments:
            - '@oro_message_queue.job.runner'
            - '@oro_message_queue.client.message_producer'
            - '@logger'
            - '@oro_website_search.async.indexer.message_granularizer.reindex'
            - '@oro_product.model.segment_message_factory'
            - '@oro_segment.provider.segment_snapshot_delta_provider'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_product.event_listener.product_collections_schedule_configuration:
        class: Oro\Bundle\ProductBundle\EventListener\ProductCollectionsScheduleConfigurationListener
        arguments:
            - '@oro_cron.deferred_scheduler'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: onUpdateAfter }

    oro_product.helper.product_collection_segment:
        class: Oro\Bundle\ProductBundle\Helper\ProductCollectionSegmentHelper
        public: false
        arguments:
            - '@oro_product.provider.content_variant_segment_provider'
            - '@?oro_web_catalog.provider.web_catalog_usage_provider'

    oro_product.event_listener.product_collection_aware_content_variant_entity_listener:
        public: false
        class: Oro\Bundle\ProductBundle\EventListener\ProductCollectionAwareContentVariantEntityListener
        arguments:
            - '@oro_product.entity.event_listener.product_collection_variant_reindex_message_send_listener'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: postPersist }
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: preUpdate }
            - { name: doctrine.orm.entity_listener, entity: '%oro_segment.segment.entity.class%', event: preRemove }

    oro_product.handler.request_content_variant:
        class: Oro\Bundle\ProductBundle\Handler\RequestContentVariantHandler
        arguments:
            - "@request_stack"

    oro_product.helper.product_grouper.factory:
        class: Oro\Bundle\ProductBundle\Helper\ProductGrouper\ProductsGrouperFactory
        public: false

    oro_product.datagrid.event_listener.search_content_variant_filtering:
        class: Oro\Bundle\ProductBundle\DataGrid\EventListener\SearchContentVariantFilteringEventListener
        arguments:
            - "@oro_product.handler.request_content_variant"
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.frontend-product-search-grid, method: onPreBuild }
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.frontend-product-search-grid, method: onBuildAfter }

    oro_product.datagrid.event_listener.frontend_product_grid:
        class: 'Oro\Bundle\ProductBundle\DataGrid\EventListener\FrontendProductGridEventListener'
        arguments:
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_entity_config.registry.attribute_type'
            - '@oro_entity_config.provider.attribute_configuration'
            - '@oro_entity.doctrine_helper'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.frontend-product-search-grid, method: onPreBuild }

    oro_product.datagrid.event_listener.frontend_product_filter_sorted_disabling:
        class: 'Oro\Bundle\ProductBundle\DataGrid\EventListener\FrontendProductFilterSorterDisablingEventListener'
        arguments:
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_entity_config.registry.attribute_type'
            - '@oro_entity_config.provider.attribute_configuration'
            - '@oro_product.website_search.repository.product'
            - '@oro_entity.doctrine_helper'
            - '@oro_datagrid.datagrid.manager.link'
            - '@oro_filter.provider.state.filters'
            - '@oro_datagrid.provider.state.sorters'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.search_datasource.result.before.frontend-product-search-grid, method: onSearchResultBefore }
            - { name: kernel.event_listener, event: oro_datagrid.search_datasource.result.after.frontend-product-search-grid, method: onSearchResultAfter }
            - { name: oro_featuretogle.feature, feature: limit_filters_sorters_on_product_listing }

    oro_product.provider.catalog_context_url_provider:
        class: Oro\Bundle\ProductBundle\Provider\ContentVariantContextUrlProvider
        public: false
        arguments:
            - '@request_stack'
            - '@oro_redirect.url_cache'
            - '@oro_frontend_localization.manager.user_localization'
        tags:
            - { name: oro_redirect.context_url_provider, alias: 'content_variant' }

    oro_product.provider.variant_field_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\VariantFieldProvider'
        public: false
        arguments:
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_entity_config.provider.serialized_field_provider'

    oro_product.provider.grid_count_provider:
        class: Oro\Bundle\ProductBundle\Provider\GridCountProvider
        arguments:
            - '@oro_datagrid.datagrid.manager'
            - '@security.authorization_checker'
            - '@oro_datagrid.extension.pager.orm.pager'

    oro_product.provider.brand_status_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\BrandStatusProvider'

    oro_product.service.product_collection_definition_converter:
        class: Oro\Bundle\ProductBundle\Service\ProductCollectionDefinitionConverter
        public: false
        arguments:
            - '@oro_query_designer.query_designer.segment_filters_purifier'

    oro_product.event_listener.product_collection_datagrid_parameters_for_selected_products_grid:
        class: Oro\Bundle\ProductBundle\EventListener\ProductCollectionDatagridParametersListener
        calls:
            - [setParameterName,  ['selectedProducts']]
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.product-collection-selected-products-grid, method: onBuildAfter }

    oro_product.event_listener.product_collection_datagrid_parameters_for_add_products_grid:
        class: Oro\Bundle\ProductBundle\EventListener\ProductCollectionDatagridParametersListener
        calls:
            - [setParameterName,  ['hiddenProducts']]
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.after.product-collection-add-products-base-grid, method: onBuildAfter }

    oro_product.datagrid.extension.mass_action.trigger_event_for_selected_product_ids_mass_action_handler:
        class: Oro\Bundle\ProductBundle\DataGrid\Extension\MassAction\TriggerEventForSelectedProductIdsMassActionHandler
        arguments:
            - '@oro_config.manager'
            - '@translator'

    oro_product.datagrid.extension.mass_action.action.trigger_event_for_selected_product_ids_mass_action:
        class: Oro\Bundle\ProductBundle\DataGrid\Extension\MassAction\Action\TriggerEventForSelectedProductIdsMassAction
        shared: false
        tags:
            - { name: oro_datagrid.extension.mass_action.type, type: trigger-event-for-selected-product-ids }

    oro_product.event_listener.product_stickers_frontend_datagrid:
        class: 'Oro\Bundle\ProductBundle\EventListener\ProductStickersFrontendDatagridListener'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.pre.frontend-product-search-grid, method: onPreBuild }
            - { name: kernel.event_listener, event: oro_datagrid.search_datasource.result.after.frontend-product-search-grid, method: onResultAfter }

    oro_product.layout.data_provider.product_stickers:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\ProductStickersProvider'
        arguments:
            - "@oro_config.manager"
        tags:
            - { name: layout.data_provider, alias: oro_product_stickers }

    oro_product.layout.data_provider.new_arrivals:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\NewArrivalsProvider'
        parent: oro_product.layout.data_provider.abstract_segment_products_provider
        tags:
            - { name: layout.data_provider, alias: new_arrivals }

    oro_product.layout.data_provider.new_arrivals.cache_decorator:
        parent: oro_product.doctrine.abstract_cached_provider_decorator
        decorates: oro_product.layout.data_provider.new_arrivals
        decoration_priority: 10
        arguments:
            - '@oro_product.layout.data_provider.new_arrivals.cache_decorator.inner'
            - '@oro.cache.memory_cache_chain'
            - 'oro_product.layout.data_provider.new_arrivals'

    oro_product.provider.segment:
        parent: oro_product.provider.segment.logging_errors

    oro_product.provider.segment.logging_errors:
        class: 'Oro\Bundle\ProductBundle\Provider\Segment\LoggingErrors\ProductSegmentWithLoggingErrorsProvider'
        public: fasle
        arguments:
            - '@oro_segment.segment_manager'
            - '@logger'

    oro_product.doctrine.abstract_cached_provider_decorator:
        class: 'Oro\Bundle\ProductBundle\Provider\Cache\Doctrine\CachedProductsProviderDecorator'
        abstract: true

    oro_product.provider.product_images_urls:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductImagesURLsProvider'
        arguments:
            - '@oro_entity.doctrine_helper'
            - '@oro_attachment.manager'

    oro_product.provider.product_images_dimensions:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductImagesDimensionsProvider'
        arguments:
            - '@oro_layout.provider.image_type'

    oro_product.event_listener.attribute_changes:
        class: 'Oro\Bundle\ProductBundle\EventListener\AttributeChangesListener'
        arguments:
            - '@request_stack'
            - '@oro_message_queue.client.message_producer'
        tags:
            - { name: kernel.event_listener, event: oro.entity_config.post_flush, method: postFlush }

    oro_product.event_listener.attribute_family_changes:
        class: 'Oro\Bundle\ProductBundle\EventListener\AttributeFamilyChangesListener'
        arguments:
            - '@request_stack'
            - '@doctrine'
            - '@event_dispatcher'
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    oro_product.provider.index_fields:
        class: 'Oro\Bundle\ProductBundle\Search\ProductIndexFieldsProvider'
        public: false
        # These attributes are forced to be indexed as a separate fields because they are used at main product grid of front store
        calls:
            - [addForceIndexed,  ['sku']]
            - [addForceIndexed,  ['names']]
            - [addForceIndexed,  ['shortDescriptions']]
            - [addForceIndexed,  ['newArrival']]

    oro_product.event_listener.website_search_mapping:
        class: 'Oro\Bundle\ProductBundle\EventListener\WebsiteSearchMappingListener'
        arguments:
            - '@oro_entity_config.manager.attribute_manager'
            - '@oro_entity_config.registry.attribute_type'
            - '@oro_entity_config.provider.attribute_configuration'
            - '@oro_product.provider.index_fields'
        tags:
            - { name: kernel.event_listener, event: oro_website_search.event.website_search_mapping.configuration, method: onWebsiteSearchMapping }

    oro_product.event_listener.entity_config:
        class: 'Oro\Bundle\ProductBundle\Search\EventListener\WebsiteSearchEntityConfigListener'
        arguments:
            - '@oro_website_search.provider.search_mapping'
        tags:
            - { name: kernel.event_listener, event: oro.entity_config.post_flush, method: postFlush, priority: -255 }

    oro_product.voter.guest_quick_order:
        parent: oro_customer.voter.anonymous_customer_user
        calls:
            - [ setFeatureName, ['guest_quick_order_form'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_product.voter.customer_user_guest_quick_order:
        parent: oro_customer.voter.customer_user
        calls:
            - [ setFeatureName, ['guest_quick_order_form'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_product.voter.guest_quick_order_form:
        class: 'Oro\Bundle\ProductBundle\Voter\GuestQuickOrderFormVoter'
        arguments:
           - '@oro_featuretoggle.voter.config_voter'
           - '@security.token_storage'
           - 'guest_quick_order'
        abstract: true

    oro_product.voter.guest_quick_order_form.config:
        class: 'Oro\Bundle\ProductBundle\Voter\GuestQuickOrderFormVoter'
        arguments:
            - '@oro_featuretoggle.voter.config_voter'
            - '@security.token_storage'
            - 'guest_quick_order_form'
        calls:
            - [ setFeatureName, ['guest_quick_order_config'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_product.provider.brand_entity_name:
        class: 'Oro\Bundle\ProductBundle\Provider\BrandEntityNameProvider'
        public: false
        tags:
            - { name: oro_entity.name_provider, priority: 100 }

    oro_product.provider.product_entity_name:
        class: 'Oro\Bundle\ProductBundle\Provider\ProductEntityNameProvider'
        public: false
        tags:
            - { name: oro_entity.name_provider, priority: 100 }

    oro_product.provider.serialized_field_provider:
        class: 'Oro\Bundle\ProductBundle\Provider\SerializedFieldProvider'
        decorates: oro_entity_config.provider.serialized_field_provider
        arguments:
            - '@oro_entity_config.provider.extend'

    oro_product.entity_alias_provider:
        class: Oro\Bundle\ProductBundle\Provider\ProductEntityAliasProvider
        public: false
        arguments:
            - '@oro_entity_config.config_manager'
            - '@oro_entity.entity_alias_duplicate_resolver'
        tags:
            - { name: oro_entity.alias_provider }

    oro_product.helper.product_image_helper:
        class: Oro\Bundle\ProductBundle\Helper\ProductImageHelper

    oro_product.validator.product_image_type_collection:
        class: 'Oro\Bundle\ProductBundle\Validator\Constraints\ProductImageTypeCollectionValidator'
        public: true
        arguments:
            - "@oro_layout.provider.image_type"
            - "@translator"
        tags:
            - { name: validator.constraint_validator, alias: oro_product_image_type_collection_validator }

    oro_product.search.product_reindex_manager:
        class: 'Oro\Bundle\ProductBundle\Search\Reindex\ProductReindexManager'
        public: false
        arguments:
            - '@event_dispatcher'

    oro_product.layout.data_provider.row_view_theme:
        class: 'Oro\Bundle\ProductBundle\Layout\DataProvider\RowViewThemeProvider'
        arguments:
            - '@oro_product.datagrid_theme_helper'
        tags:
            - { name: layout.data_provider, alias: oro_product_datagrid_row_view }

    oro_product.event_listener.orm.new_arrival_index_listener:
        class: Oro\Bundle\EntityBundle\EventListener\ORM\PartialIndexListener
        public: false
        arguments:
            - 'oro_product'
            - 'idx_oro_product_new_arrival'
        tags:
            - { name: doctrine.event_listener, event: loadClassMetadata, connection: default }

    oro_product.event_listener.orm.featured_index_listener:
        class: Oro\Bundle\EntityBundle\EventListener\ORM\PartialIndexListener
        public: false
        arguments:
            - 'oro_product'
            - 'idx_oro_product_featured'
        tags:
            - { name: doctrine.event_listener, event: loadClassMetadata, connection: default }

    oro_product.action.condition.at_least_one_available_product:
        class: Oro\Bundle\ProductBundle\Action\Condition\AtLeastOneAvailableProduct
        arguments:
            - "@oro_product.repository.product"
            - "@oro_product.product.manager"
        tags:
            - { name: oro_action.condition, alias: at_least_one_available_product }

    oro_product.action.remove_restricted_products:
        class: Oro\Bundle\ProductBundle\Action\RemoveRestrictedProducts
        arguments:
            - "@oro_product.repository.product"
            - "@oro_product.product.manager"
            - '@oro_action.expression.context_accessor'
        tags:
            - { name: oro_action.action, alias: remove_restricted_products }

    oro_product.async.reindex_products_by_attribute_processor:
        class: Oro\Bundle\ProductBundle\Async\ReindexProductsByAttributeProcessor
        arguments:
            - '@oro_message_queue.job.runner'
            - '@doctrine'
            - '@event_dispatcher'
            - '@logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor', topicName: 'oro_product.reindex_products_by_attribute' }

    oro_product.config.event_listener.display_simple_variations_listener:
        class: Oro\Bundle\ProductBundle\EventListener\Config\DisplaySimpleVariationsListener
        arguments:
            - '@oro_product.layout.data_provider.cache_cleaner'
            - '@oro_catalog.layout.data_provider.category.cache_cleaner'
            - 'oro_product.display_simple_variations'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: onUpdateAfter }

    oro_product.event_listener.restrict_display_product_variants:
        class: 'Oro\Bundle\ProductBundle\EventListener\Visibility\Restrictions\RestrictProductVariationsEventListener'
        arguments:
            - "@oro_config.manager"
            - "@oro_frontend.request.frontend_helper"
            - "@oro_product.model.restrict_display_product_variants_query_builder_modifier"
        tags:
            - { name: kernel.event_listener, event: oro_product.product_search_query.restriction, method: onSearchQuery }
            - { name: kernel.event_listener, event: oro_product.product_db_query.restriction, method: onDBQuery }

    oro_product.event_listener.reindex_parent_configurable_product:
        class: 'Oro\Bundle\ProductBundle\EventListener\Search\ReindexParentConfigurableProductListener'
        public: false
        arguments:
            - '@oro_website.indexation_entities_container'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product.class%', event: postPersist }
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product.class%', event: postUpdate }
            - { name: doctrine.orm.entity_listener, entity: '%oro_product.entity.product.class%', event: preRemove }

    oro_product.model.restrict_display_product_variants_query_builder_modifier:
        class: 'Oro\Bundle\ProductBundle\Model\RestrictProductVariationsBuilderModifier'
        public: false
        arguments:
            - '@oro_entity.doctrine_helper'
