parameters:
    oro_checkout.entity.checkout.class: Oro\Bundle\CheckoutBundle\Entity\Checkout
    oro_checkout.entity.checkout_source.class: Oro\Bundle\CheckoutBundle\Entity\CheckoutSource
    oro_checkout.entity.checkout_workflow_state.class: Oro\Bundle\CheckoutBundle\Entity\CheckoutWorkflowState

services:
    # Data Providers
    oro_checkout.data_provider.converter.checkout_line_items:
        class: 'Oro\Bundle\CheckoutBundle\DataProvider\Converter\CheckoutLineItemsConverter'
        public: false

    oro_checkout.data_provider.converter.checkout_to_order:
        class: Oro\Bundle\CheckoutBundle\DataProvider\Converter\CheckoutToOrderConverter
        public: false
        arguments:
            - '@oro_checkout.data_provider.manager.checkout_line_items'
            - '@oro_checkout.mapper.order_mapper'
            - '@oro_checkout.checkout_to_order_converter.cache'

    oro_checkout.checkout_to_order_converter.cache:
        parent: doctrine_cache.abstract.array
        public: false
        calls:
            - [ setNamespace, [ 'checkout_to_order_converter' ] ]

    oro_checkout.product_availability.cache:
        parent: doctrine_cache.abstract.array
        calls:
            - [ setNamespace, [ 'oro_product_availability' ] ]

    oro_checkout.event_listener.product_availability_cache:
        class: Oro\Bundle\CheckoutBundle\EventListener\ProductAvailabilityCacheListener
        arguments:
            - '@oro_checkout.product_availability.cache'
        tags:
            - { name: doctrine.event_listener, event: onFlush }

    oro_checkout.data_provider.manager.checkout_line_items:
        class: 'Oro\Bundle\CheckoutBundle\DataProvider\Manager\CheckoutLineItemsManager'
        public: false
        arguments:
            - '@oro_checkout.data_provider.converter.checkout_line_items'
            - '@oro_pricing.user_currency_manager'
            - '@oro_config.manager'
            - '@security.authorization_checker'

    oro_checkout.layout.data_provider.line_items_totals:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\LineItemsWithTotalsProvider'
        arguments:
            - '@oro_checkout.data_provider.manager.checkout_line_items'
            - '@oro_pricing.subtotal_processor.provider.subtotal_line_item'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_line_items_totals }

    oro_checkout.layout.data_provider.totals:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\TotalsProvider'
        arguments:
            - '@oro_checkout.provider.checkout_totals'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_totals }

    oro_checkout.layout.data_provider.transition_form:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\TransitionFormProvider'
        arguments:
            - '@form.factory'
            - '@router'
        calls:
            - [setTransitionProvider, ['@oro_checkout.layout.data_provider.transition']]
        tags:
            - { name: layout.data_provider, alias: oro_checkout_transition_form }

    oro_checkout.layout.data_provider.single_page_transition_form:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\TransitionFormProvider'
        arguments:
            - '@form.factory'
            - '@router'
        calls:
            - [setTransitionProvider, ['@oro_checkout.layout.data_provider.single_page_transition']]
        tags:
            - { name: layout.data_provider, alias: oro_checkout_single_page_transition_form }

    oro_checkout.layout.data_provider.checkout_steps:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\CheckoutStepsProvider'
        arguments:
            - '@oro_workflow.manager'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_steps }

    oro_checkout.layout.data_provider.transition:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\TransitionProvider'
        arguments:
            - '@oro_workflow.manager'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_transition }

    oro_checkout.layout.data_provider.single_page_transition:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\SinglePageTransitionProvider'
        arguments:
            - '@oro_checkout.layout.data_provider.transition'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_single_page_transition }

    oro_checkout.model.action.get_order_line_items:
        class: 'Oro\Bundle\CheckoutBundle\Model\Action\GetOrderLineItems'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.data_provider.manager.checkout_line_items'
        tags:
            - { name: oro_action.action, alias: get_order_line_items }

    oro_checkout.layout.data_provider.shipping_context:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\CheckoutShippingContextProvider'
        arguments:
            - '@oro_checkout.factory.shipping_context_factory'
            - '@oro_checkout.checkout_context.cache'
        tags:
            - { name: layout.data_provider, alias: checkout_shipping_context }

    oro_checkout.layout.data_provider.payment_context:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\CheckoutPaymentContextProvider'
        arguments:
            - '@oro_checkout.factory.payment_context_factory'
            - '@oro_checkout.checkout_context.cache'
        tags:
            - { name: layout.data_provider, alias: checkout_payment_context }

    oro_checkout.checkout_context.cache:
        parent: doctrine_cache.abstract.array
        public: false
        calls:
            - [ setNamespace, [ 'checkout_context_cache' ] ]

    oro_checkout.expression.acl_granted:
        class: Oro\Bundle\CheckoutBundle\Expression\CheckRequest
        arguments:
            - '@request_stack'
        tags:
            - { name: oro_action.condition, alias: check_request }

    oro_checkout.twig.line_items:
        class: 'Oro\Bundle\CheckoutBundle\Twig\LineItemsExtension'
        public: false
        arguments:
            - '@service_container'
        tags:
            - { name: twig.extension }

    oro_checkout.event_listener.resolve_payment_term:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\ResolvePaymentTermListener'
        arguments:
            - '@request_stack'
            - '@doctrine'
            - '@oro_payment_term.provider.payment_term'
        tags:
            - { name: kernel.event_listener, event: oro_payment_term.resolve.payment_term, method: onResolvePaymentTerm }

    oro_checkout.event_listener.shopping_list:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\ShoppingListListener'
        public: false
        arguments:
            - '@doctrine'
            - '%oro_checkout.entity.checkout.class%'
            - '%oro_checkout.entity.checkout_source.class%'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_shopping_list.entity.shopping_list.class%', event: preRemove }

    oro_checkout.repository.checkout:
        class: 'Oro\Bundle\CheckoutBundle\Entity\Repository\CheckoutRepository'
        parent: oro_entity.abstract_repository
        arguments:
            - '%oro_checkout.entity.checkout.class%'

    oro_checkout.datagrid.checkout_grid_listener:
        class: Oro\Bundle\CheckoutBundle\Datagrid\CheckoutGridListener
        arguments:
            - '@oro_pricing.user_currency_manager'
            - '@oro_checkout.repository.checkout'
            - '@oro_pricing.subtotal_processor.total_processor_provider'
            - '@oro_entity.entity_name_resolver'
            - '@oro_entity.doctrine_helper'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.frontend-checkouts-grid, method: onBuildBefore }
            - { name: kernel.event_listener, event: oro_datagrid.orm_datasource.result.after.frontend-checkouts-grid, method: onResultAfter }

    oro_checkout.datagrid.checkout_grid_column_filter:
        class: 'Oro\Bundle\CheckoutBundle\Datagrid\CheckoutGridCustomerUserNameListener'
        arguments:
            - '@oro_customer.security.customer_user_provider'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.frontend-checkouts-grid, method: onBuildBefore }

    oro_checkout.datagrid.checkout_grid_customer_visitor_acl_listener:
        class: 'Oro\Bundle\CheckoutBundle\Datagrid\CheckoutGridCustomerVisitorAclListener'
        arguments:
            - '@security.token_storage'
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.frontend-checkouts-grid, method: onBuildBefore }

    oro_checkout.workflow.condition.order_line_item_has_count:
        class: 'Oro\Bundle\CheckoutBundle\Model\Condition\OrderLineItemsHasCount'
        arguments:
            - '@oro_checkout.data_provider.manager.checkout_line_items'
        tags:
            - { name: oro_action.condition, alias: order_line_item_has_count }

    oro_checkout.layout.provider.open_orders_separate_page_config:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\OpenOrdersSeparatePageConfigProvider'
        arguments:
            - '@oro_config.manager'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_separate_open_orders }

    oro_checkout.migration.post_up.listener:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\PostUpMigrationListener'
        tags:
            - { name: kernel.event_listener, event: oro_migration.post_up, method: onPostUp, priority: -80 }

    oro_checkout.workflow_state.storage.checkout_state_diff_storage:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Storage\CheckoutDiffStorage'
        public: false
        arguments:
            - '@oro_entity.doctrine_helper'
            - '%oro_checkout.entity.checkout_workflow_state.class%'

    oro_checkout.workflow_state.manager.checkout_state_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Manager\CheckoutStateDiffManager'
        arguments:
            - '@oro_checkout.workflow_state.mapper.registry.checkout_state_diff'

    oro_checkout.workflow_state.mapper.registry.checkout_state_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\CheckoutStateDiffMapperRegistry'
        public: false

    oro_checkout.workflow_state.mapper.workflow_step:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\WorkflowStepMapper'
        arguments:
            - '@oro_checkout.workflow.manager.b2b_flow_checkout'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.ship_to_billing_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\ShipToBillingDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.billing_address_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\BillingAddressDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.shipping_address_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\ShippingAddressDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.payment_method_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\PaymentMethodDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.total_amount_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\TotalAmountDiffMapper'
        arguments:
            - '@oro_pricing.subtotal_processor.total_processor_provider'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.ship_until_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\ShipUntilDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.po_number_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\PoNumberDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.customer_notes_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\CustomerNotesDiffMapper'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.shipping_method_diff:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\ShippingMethodDiffMapper'
        arguments:
            - '@oro_checkout.shipping_method.provider_main'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.mapper.shipping_method_enabled:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Mapper\ShippingMethodEnabledMapper'
        arguments:
            - '@oro_checkout.shipping_method.provider_main'
            - '@oro_checkout.factory.shipping_context_factory'
        public: false
        tags:
            - { name: checkout.workflow_state.mapper }

    oro_checkout.workflow_state.action.get_checkout_state:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Action\GetCheckoutStateAction'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.workflow_state.storage.checkout_state_diff_storage'
        tags:
            - { name: oro_action.action, alias: get_checkout_state }

    oro_checkout.workflow_state.action.save_checkout_state:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Action\SaveCheckoutStateAction'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.workflow_state.storage.checkout_state_diff_storage'
        tags:
            - { name: oro_action.action, alias: save_checkout_state }

    oro_checkout.workflow_state.action.delete_checkout_state:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Action\DeleteCheckoutStateAction'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.workflow_state.storage.checkout_state_diff_storage'
        tags:
            - { name: oro_action.action, alias: delete_checkout_state }

    oro_checkout.workflow_state.action.generate_checkout_state_snapshot:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Action\GenerateCheckoutStateSnapshotAction'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.workflow_state.manager.checkout_state_diff'
        tags:
            - { name: oro_action.action, alias: generate_checkout_state_snapshot }

    oro_checkout.workflow_state.condition.check_checkout_states:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Condition\CheckCheckoutStates'
        arguments:
            - '@oro_checkout.workflow_state.manager.checkout_state_diff'
        tags:
            - { name: oro_action.condition, alias: check_checkout_states }

    oro_checkout.workflow_state.handler.checkout_error:
        class: 'Oro\Bundle\CheckoutBundle\WorkflowState\Handler\CheckoutErrorHandler'
        arguments:
            - '@session.flash_bag'

    oro_checkout.workflow.manager.b2b_flow_checkout:
        parent: oro_workflow.abstract.workflow_aware_manager
        calls:
            - ['setWorkflowName', ['b2b_flow_checkout']]

    oro_checkout.entity_listener.remove_checkout_workflow_states:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\RemoveCheckoutWorkflowStatesListener'
        arguments:
            - '@oro_entity.doctrine_helper'
            - '%oro_checkout.entity.checkout_workflow_state.class%'
        public: false
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_checkout.entity.checkout.class%', event: preRemove }

    oro_checkout.provider.checkout_totals:
        class: 'Oro\Bundle\CheckoutBundle\Provider\CheckoutTotalsProvider'
        arguments:
            - '@oro_checkout.data_provider.converter.checkout_to_order'
            - '@oro_pricing.subtotal_processor.total_processor_provider'
            - '@oro_checkout.shipping_method.provider_main'

    oro_checkout.action.default_shipping_method_setter:
        class: 'Oro\Bundle\CheckoutBundle\Action\DefaultShippingMethodSetter'
        arguments:
            - '@oro_checkout.shipping_method.provider_main'

    oro_checkout.action.default_shipping_method_setter_decorator:
        class: 'Oro\Bundle\CheckoutBundle\Action\DefaultShippingMethodSetterDecorator'
        decorates: oro_checkout.action.default_shipping_method_setter
        public: false
        arguments:
            - '@oro_checkout.action.default_shipping_method_setter_decorator.inner'

    oro_checkout.factory.shipping_context_factory:
        class: 'Oro\Bundle\CheckoutBundle\Factory\CheckoutShippingContextFactory'
        arguments:
            - '@oro_checkout.data_provider.manager.checkout_line_items'
            - '@oro_checkout.provider.checkout_subtotal'
            - '@oro_pricing.subtotal_processor.total_processor_provider'
            - '@oro_order.shipping_line_item.converter_basic'
            - '@?oro_shipping.context.builder_factory_basic'

    oro_checkout.factory.payment_context_factory:
        class: 'Oro\Bundle\CheckoutBundle\Factory\CheckoutPaymentContextFactory'
        arguments:
            - '@oro_checkout.data_provider.manager.checkout_line_items'
            - '@oro_checkout.provider.checkout_subtotal'
            - '@oro_pricing.subtotal_processor.total_processor_provider'
            - '@oro_order.payment_line_item.converter_basic'
            - '@oro_shipping.shipping_origin.provider'
            - '@?oro_payment.context.builder_factory_basic'

    oro_checkout.provider.privilege_category_provider:
        class: 'Oro\Bundle\CheckoutBundle\Provider\PrivilegeCategoryProvider'
        tags:
            - { name: oro_user.privilege_category}

    oro_checkout.mapper.order_mapper:
        class: 'Oro\Bundle\CheckoutBundle\Mapper\OrderMapper'
        public: false
        arguments:
            - '@oro_entity.helper.field_helper'
            - '@property_accessor'
            - '@oro_payment_term.provider.payment_term_association'

    oro_checkout.model.action.create_order:
        class: 'Oro\Bundle\CheckoutBundle\Model\Action\CreateOrder'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.mapper.order_mapper'
        tags:
            - { name: oro_action.action, alias: create_order }

    oro_checkout.listener.checkout_workflow:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\CheckoutWorkflowListener'
        arguments:
            - '@doctrine'
            - '%oro_checkout.entity.checkout.class%'
        tags:
            - { name: oro_workflow.changes.listener, event: oro.workflow.deactivated, method: onDeactivationWorkflowDefinition }

    oro_checkout.listener.checkout:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\CheckoutListener'
        arguments:
            - '@oro_user.provider.default_user'
            - '@oro_security.token_accessor'
            - '@oro_website.manager'
        tags:
            - { name: doctrine.orm.entity_listener, entity: '%oro_checkout.entity.checkout.class%', event: postUpdate }
            - { name: doctrine.orm.entity_listener, entity: '%oro_checkout.entity.checkout.class%', event: prePersist }

    oro_checkout.listener.checkout_subtotal:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\CheckoutSubtotalListener'
        public: true
        arguments:
            - '@doctrine'
            - '@oro_message_queue.client.message_producer'
        tags:
            - { name: kernel.event_listener, event: oro_pricing.combined_price_list.update, method: onPriceListUpdate }
            - { name: kernel.event_listener, event: oro_pricing.customer.combined_price_list.update, method: onCustomerPriceListUpdate }
            - { name: kernel.event_listener, event: oro_pricing.customer_group.combined_price_list.update, method: onCustomerGroupPriceListUpdate }
            - { name: kernel.event_listener, event: oro_pricing.website.combined_price_list.update, method: onWebsitePriceListUpdate }
            - { name: kernel.event_listener, event: oro_pricing.config.combined_price_list.update, method: onConfigPriceListUpdate }

    oro_checkout.acl.voter.checkout:
        class: 'Oro\Bundle\CheckoutBundle\Acl\Voter\CheckoutVoter'
        public: false
        arguments:
            - '@oro_entity.doctrine_helper'
        calls:
            - [setContainer, ["@service_container"]]
        tags:
            - { name: security.voter }

    oro_checkout.shipping_method.price_provider_chain_element:
        class: 'Oro\Bundle\CheckoutBundle\Shipping\Method\Chain\Member\Price\PriceCheckoutShippingMethodsProviderChainElement'
        arguments:
            - '@oro_shipping.shipping_price.provider'
            - '@oro_checkout.factory.shipping_context_factory'

    oro_checkout.condition.checkout_has_applicable_shipping_methods:
        class: 'Oro\Bundle\CheckoutBundle\Condition\CheckoutHasApplicableShippingMethods'
        arguments:
            - '@oro_checkout.shipping_method.provider_main'
        tags:
            - { name: oro_action.condition, alias: 'checkout_has_applicable_shipping_methods' }

    oro_checkout.datagrid.action_permission_provider:
        class: 'Oro\Bundle\CheckoutBundle\Datagrid\ActionPermissionProvider'

    oro_checkout.event_listener.shipping_methods:
        class: Oro\Bundle\CheckoutBundle\EventListener\ShippingMethodsListener
        arguments:
            - '@oro_order.order.provider.order_address'
            - '@oro_order.order.provider.order_address_security'
            - '@oro_order.manager.order_address'
            - '@oro_shipping.provider.methods_configs_rules.by_context_required_parameters'
            - '@oro_checkout.factory.shipping_context_factory'
        tags:
            - { name: kernel.event_listener, event: extendable_condition.start_checkout, method: onStartCheckout }

    oro_checkout.event_listener.payment_methods:
        class: Oro\Bundle\CheckoutBundle\EventListener\PaymentMethodsListener
        arguments:
            - '@oro_order.order.provider.order_address'
            - '@oro_order.order.provider.order_address_security'
            - '@oro_order.manager.order_address'
            - '@oro_payment.provider.methods_configs_rules.by_context_required_parameters'
            - '@oro_checkout.factory.payment_context_factory'
        tags:
            - { name: kernel.event_listener, event: extendable_condition.start_checkout, method: onStartCheckout }

    oro_checkout.event_listener.has_price_in_shopping_line_items:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\HasPriceInShoppingLineItemsListener'
        arguments:
            - '@oro_pricing.provider.product_price'
            - '@oro_pricing.user_currency_manager'
            - '@oro_pricing.model.product_price_scope_criteria_request_handler'
        tags:
            - { name: kernel.event_listener, event: extendable_condition.start_checkout, method: onStartCheckoutConditionCheck }

    oro_checkout.payment.method.event_listener.method_renaming:
        class: 'Oro\Bundle\CheckoutBundle\Payment\Method\EventListener\MethodRenamingListener'
        arguments:
            - '@oro_checkout.repository.checkout'
        tags:
            - { name: kernel.event_listener, event: oro_payment.method_renaming, method: onMethodRename}

    oro_checkout.provider.payment_method_provider:
        class: Oro\Bundle\CheckoutBundle\Provider\PaymentMethodProvider
        arguments:
            - '@oro_checkout.factory.payment_context_factory'
            - '@oro_checkout.repository.checkout'
            - '@oro_payment.method.provider.method_provider'

    oro_checkout.provider.result_messages:
        class: Oro\Bundle\CheckoutBundle\Provider\PaymentResultMessageProvider
        decorates: oro_payment.provider.result_messages
        public: false
        arguments: ['@oro_checkout.provider.payment_method_provider']

    oro_checkout.event_listener.system_config:
        parent: oro_user.event_listener.default_user_system_config
        calls:
            - [setAlias, ['oro_checkout']]
            - [setConfigKey, ['default_guest_checkout_owner']]
        tags:
            - { name: kernel.event_listener, event: oro_config.settings_form_preset, method: onFormPreSetData }
            - { name: kernel.event_listener, event: oro_config.settings_before_save.oro_checkout.default_guest_checkout_owner, method: onSettingsSaveBefore }

    oro_checkout.voter.guest_checkout:
        parent: oro_customer.voter.anonymous_customer_user
        calls:
            - [ setFeatureName, ['guest_checkout'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_checkout.voter.customer_user_checkout:
        parent: oro_customer.voter.customer_user
        calls:
            - [ setFeatureName, ['guest_checkout'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_checkout.voter.guest_quick_order_form:
        parent: oro_product.voter.guest_quick_order_form
        calls:
            - [ setFeatureName, ['guest_checkout'] ]
        tags:
            - { name: oro_featuretogle.voter }

    oro_checkout.condition.is_workflow_start_from_shopping_list_allowed:
        class: Oro\Bundle\CheckoutBundle\Condition\IsWorkflowStartFromShoppingListAllowed
        arguments:
           - '@oro_featuretoggle.checker.feature_checker'
           - '@security.token_storage'
        lazy: true

    #Checkout Line Items Services
    oro_checkout.line_item.converter_registry:
        class: 'Oro\Bundle\CheckoutBundle\Model\CheckoutLineItemConverterRegistry'
        arguments:
            - '@logger'

    oro_checkout.line_items.factory:
        class: 'Oro\Bundle\CheckoutBundle\Factory\CheckoutLineItemsFactory'
        arguments:
            - '@oro_checkout.line_item.converter_registry'

    oro_checkout.line_item.converter.shopping_list:
        class: 'Oro\Bundle\CheckoutBundle\Converter\ShoppingListLineItemConverter'
        public: false
        tags:
            - { name: oro.checkout.line_item.converter, alias: shopping_list }

    oro_checkout.line_item.converter.order:
        class: 'Oro\Bundle\CheckoutBundle\Converter\OrderLineItemConverter'
        arguments:
            - '@oro_config.manager'
            - '@oro_inventory.provider.inventory_quantity'
            - '@security.authorization_checker'
            - 'oro_product.general_frontend_product_visibility'
        tags:
            - { name: oro.checkout.line_item.converter, alias: order }

    oro_checkout.data_provider.checkout_line_items:
        class: 'Oro\Bundle\CheckoutBundle\DataProvider\LineItem\CheckoutLineItemsDataProvider'
        public: false
        arguments:
            - '@oro_pricing.provider.frontend_product_prices'
            - '@security.authorization_checker'
            - '@oro_checkout.product_availability.cache'
        tags:
            - { name: checkout.data_provider.line_item }

    oro_checkout.provider.checkout_subtotal:
        class: 'Oro\Bundle\CheckoutBundle\Provider\CheckoutSubtotalProvider'
        arguments:
            - '@translator'
            - '@oro_currency.rounding.price_rounding_service'
            - '@oro_pricing.provider.product_price'
            - '@oro_pricing.model.price_list_tree_handler'
            - '@oro_pricing.subtotal_processor.provider.arguments'
            - '@oro_featuretoggle.checker.feature_checker'
            - '@oro_pricing.model.product_price_scope_criteria_factory'
        tags:
            - { name: oro_pricing.subtotal_provider, priority: 0 }

    oro_checkout.model.checkout_subtotal_updater:
        class: 'Oro\Bundle\CheckoutBundle\Model\CheckoutSubtotalUpdater'
        arguments:
            - '@doctrine'
            - '@oro_checkout.provider.checkout_subtotal'
            - '@oro_pricing.user_currency_manager'

    oro_checkout.async.recalculate_checkout_subtotals_processor:
        class: 'Oro\Bundle\CheckoutBundle\Async\RecalculateCheckoutSubtotalsProcessor'
        arguments:
            - '@oro_checkout.model.checkout_subtotal_updater'
            - '@monolog.logger'
        tags:
            - { name: oro_message_queue.client.message_processor }

    oro_checkout.provider.checkout_line_items:
        class: 'Oro\Bundle\CheckoutBundle\Provider\CheckoutLineItemsProvider'

    oro_checkout.event_listener.login_on_checkout:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\LoginOnCheckoutListener'
        arguments:
            - '@logger'
            - '@oro_config.manager'
            - '@oro_checkout.manager'
            - '@event_dispatcher'
        lazy: true
        tags:
            - { name: kernel.event_listener, event: security.interactive_login, method: onInteractiveLogin, priority: 255 }

    oro_checkout.event_listener.customer_user_register:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\CustomerUserListener'
        arguments:
            - '@request_stack'
            - '@oro_checkout.manager'
            - '@oro_config.manager'
            - '@oro_customer.security.login_manager'
            - '%oro_customer.firewall_name%'
        lazy: true
        tags:
            - { name: kernel.event_listener, event: oro.form.update_handler.after_entity_flush.oro_customer_frontend_customer_user_register, method: afterFlush }
            - { name: kernel.event_listener, event: oro_customer.customer_user_email_send_event, method: onCustomerUserEmailSend }

    oro_checkout.event_listener.customer_user_reset_password_listener:
        class: 'Oro\Bundle\CheckoutBundle\EventListener\CustomerUserResetPasswordListener'
        lazy: true
        arguments:
            - '@request_stack'
        tags:
            - { name: kernel.event_listener, event: oro_customer.customer_user_email_send_event, method: onCustomerUserEmailSend }

    oro_checkout.manager:
        class: 'Oro\Bundle\CheckoutBundle\Manager\CheckoutManager'
        arguments:
            - '@oro_entity.doctrine_helper'

    oro_checkout.action.get_start_checkout_transition:
        class: 'Oro\Bundle\CheckoutBundle\Action\StartCheckoutTransitionAction'
        arguments:
            - '@oro_action.expression.context_accessor'
            - '@oro_checkout.condition.is_workflow_start_from_shopping_list_allowed'
        tags:
            - { name: oro_action.action, alias: get_start_checkout_transition }

    oro_checkout.provider.forgot_password_check_email:
        class: 'Oro\Bundle\CheckoutBundle\Layout\DataProvider\CheckoutForgotPasswordCheckEmailProvider'
        lazy: true
        arguments:
            - '@request_stack'
            - '@session'
        tags:
            - { name: layout.data_provider, alias: oro_checkout_forgot_password_check_email }

    oro_checkout.helper.checkout_workflow_helper:
        class: Oro\Bundle\CheckoutBundle\Helper\CheckoutWorkflowHelper
        arguments:
            - '@oro_workflow.manager'
            - '@oro_action.action_group_registry'
            - '@oro_checkout.layout.data_provider.transition'
            - '@oro_checkout.layout.data_provider.transition_form'
            - '@oro_checkout.workflow_state.handler.checkout_error'
            - '@oro_checkout.data_provider.manager.checkout_line_items'
            - '@oro_customer.handler.customer_registration_handler'
            - '@oro_customer.handler.forgot_password'
            - '@event_dispatcher'
            - '@translator'

    oro_checkout.condition.validate_checkout_addresses:
        class: 'Oro\Bundle\CheckoutBundle\Condition\ValidateCheckoutAddresses'
        arguments:
            - '@validator'
        tags:
            - { name: oro_workflow.condition, alias: 'validate_checkout_addresses' }
            - { name: oro_action.condition, alias: 'validate_checkout_addresses' }

    oro_checkout.action.send_order_confirmation_email:
        class: 'Oro\Bundle\CheckoutBundle\Action\SendOrderConfirmationEmail'
        parent: oro_email.workflow.action.send_email_template
        tags:
            - { name: oro_action.action, alias: send_order_confirmation_email }
